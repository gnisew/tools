<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç…§ç‰‡è²¼åœ–ç·¨è¼¯å™¨</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (ç”¨æ–¼å¿«é€Ÿæ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fabric.js (ç”¨æ–¼ç•«å¸ƒæ“ä½œ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <!-- æ¨£å¼èª¿æ•´ -->
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overscroll-behavior: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰åˆ·æ–° */
        }
        /* éš±è—æª”æ¡ˆä¸Šå‚³ input */
        .hidden-input {
            display: none;
        }
        canvas {
            border: 1px dashed #ccc;
        }
        /* è²¼åœ–é¸å–®æ¨£å¼ */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .sticker-item {
            font-size: 2rem;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        .sticker-item:active {
            background: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
        <h1 class="text-lg font-bold text-gray-800">ğŸ“· è²¼åœ–ç·¨è¼¯å™¨</h1>
        <button onclick="downloadImage()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow active:bg-blue-700 transition">
            å„²å­˜åœ–ç‰‡
        </button>
    </header>

    <!-- ä¸»è¦ç•«å¸ƒå€åŸŸ -->
    <main class="flex-1 flex items-center justify-center bg-gray-200 p-2 relative overflow-hidden" id="canvas-container">
        <!-- å°šæœªä¸Šå‚³ç…§ç‰‡æ™‚çš„æç¤º -->
        <div id="placeholder-text" class="absolute text-gray-500 text-center pointer-events-none">
            <p class="text-4xl mb-2">ğŸ–¼ï¸</p>
            <p>è«‹å…ˆé»æ“Šä¸‹æ–¹ã€Œä¸Šå‚³ç…§ç‰‡ã€</p>
        </div>
        
        <canvas id="c"></canvas>
    </main>

    <!-- æ§åˆ¶æŒ‰éˆ•å€ (é‡å°åˆªé™¤åŠŸèƒ½) -->
    <div id="object-controls" class="bg-red-50 p-2 flex justify-center hidden">
        <button onclick="deleteSelected()" class="text-red-600 font-bold text-sm flex items-center gap-2">
            ğŸ—‘ï¸ åˆªé™¤é¸å–çš„é …ç›®
        </button>
    </div>

    <!-- åº•éƒ¨å·¥å…·åˆ— -->
    <footer class="bg-white border-t p-3 pb-8 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
        <div class="grid grid-cols-4 gap-2">
            <!-- 1. ä¸Šå‚³èƒŒæ™¯ -->
            <button onclick="document.getElementById('bg-upload').click()" class="flex flex-col items-center justify-center p-2 rounded hover:bg-gray-50 text-gray-700">
                <span class="text-2xl">ğŸ“·</span>
                <span class="text-xs mt-1">ä¸Šå‚³ç…§ç‰‡</span>
            </button>
            <input type="file" id="bg-upload" class="hidden-input" accept="image/*">

            <!-- 2. åŠ æ–‡å­— -->
            <button onclick="addText()" class="flex flex-col items-center justify-center p-2 rounded hover:bg-gray-50 text-gray-700">
                <span class="text-2xl">Aa</span>
                <span class="text-xs mt-1">åŠ æ–‡å­—</span>
            </button>

            <!-- 3. åŠ è²¼åœ– (é¸å–®) -->
            <button onclick="toggleStickerMenu()" class="flex flex-col items-center justify-center p-2 rounded hover:bg-gray-50 text-gray-700">
                <span class="text-2xl">ğŸ˜Š</span>
                <span class="text-xs mt-1">åŠ è²¼åœ–</span>
            </button>

            <!-- 4. ä¸Šå‚³è‡ªå®šç¾©è²¼åœ– -->
            <button onclick="document.getElementById('sticker-upload').click()" class="flex flex-col items-center justify-center p-2 rounded hover:bg-gray-50 text-gray-700">
                <span class="text-2xl">ğŸ“¤</span>
                <span class="text-xs mt-1">ä¸Šå‚³åœ–å±¤</span>
            </button>
            <input type="file" id="sticker-upload" class="hidden-input" accept="image/*">
        </div>

        <!-- è²¼åœ–é¸æ“‡é¢æ¿ (é è¨­éš±è—) -->
        <div id="sticker-menu" class="hidden mt-4 border-t pt-4">
            <p class="text-xs text-gray-500 mb-2 font-bold">é»æ“ŠåŠ å…¥è²¼åœ–ï¼š</p>
            <div class="sticker-grid">
                <!-- é€™è£¡çš„è²¼åœ–ç”± JS å‹•æ…‹ç”Ÿæˆï¼Œæˆ–è€…ç›´æ¥å¯«æ­» -->
                <div class="sticker-item" onclick="addEmoji('ğŸ˜')">ğŸ˜</div>
                <div class="sticker-item" onclick="addEmoji('â¤ï¸')">â¤ï¸</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ”¥')">ğŸ”¥</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ‰')">ğŸ‰</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ‘')">ğŸ‘</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ±')">ğŸ±</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ¶')">ğŸ¶</div>
                <div class="sticker-item" onclick="addEmoji('ğŸŒŸ')">ğŸŒŸ</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ’¢')">ğŸ’¢</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ’§')">ğŸ’§</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ‘‘')">ğŸ‘‘</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ•¶ï¸')">ğŸ•¶ï¸</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ’¬')">ğŸ’¬</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ€')">ğŸ€</div>
                <div class="sticker-item" onclick="addEmoji('ğŸ’¯')">ğŸ’¯</div>
            </div>
            <button onclick="toggleStickerMenu()" class="w-full mt-2 py-2 text-center text-gray-500 text-sm bg-gray-100 rounded">é—œé–‰é¸å–®</button>
        </div>
    </footer>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // 1. åˆå§‹åŒ– Fabric Canvas
        const canvas = new fabric.Canvas('c', {
            preserveObjectStacking: true, // é¸å–ç‰©ä»¶æ™‚ä¿æŒå±¤ç´šï¼Œä¸è‡ªå‹•è·‘åˆ°æœ€ä¸Šå±¤
        });
        
        // è¨­å®šé¸å–æ¡†çš„æ¨£å¼ (æ›´é©åˆæ‰‹æ©Ÿæ“ä½œ)
        fabric.Object.prototype.set({
            transparentCorners: false,
            cornerColor: '#ffffff',
            cornerStrokeColor: '#3b82f6',
            borderColor: '#3b82f6',
            cornerSize: 20, // æ‰‹æ©Ÿä¸Šæ“ä½œé»è¦å¤§ä¸€é»
            padding: 10,
            borderDashArray: [4, 4]
        });

        // è¢å¹•å¯¬åº¦èˆ‡å®¹å™¨
        const container = document.getElementById('canvas-container');
        let containerWidth = container.offsetWidth;
        let containerHeight = container.offsetHeight;

        // åˆå§‹åŒ–ç•«å¸ƒå¤§å° (é è¨­æ­£æ–¹å½¢)
        resizeCanvas(300, 300);

        // 2. ç›£è½ç‰©ä»¶é¸å–ï¼Œé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
        const deleteBtnDiv = document.getElementById('object-controls');
        
        canvas.on('selection:created', () => deleteBtnDiv.classList.remove('hidden'));
        canvas.on('selection:updated', () => deleteBtnDiv.classList.remove('hidden'));
        canvas.on('selection:cleared', () => deleteBtnDiv.classList.add('hidden'));

        // --- åŠŸèƒ½å‡½æ•¸ ---

        // èª¿æ•´ç•«å¸ƒå¤§å°å‡½æ•¸
        function resizeCanvas(w, h) {
            canvas.setWidth(w);
            canvas.setHeight(h);
            canvas.renderAll();
        }

        // A. ä¸Šå‚³èƒŒæ™¯ç…§ç‰‡
        document.getElementById('bg-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(f) {
                const data = f.target.result;
                fabric.Image.fromURL(data, function(img) {
                    // éš±è—æç¤ºæ–‡å­—
                    document.getElementById('placeholder-text').style.display = 'none';

                    // è¨ˆç®—é©é…è¢å¹•çš„å°ºå¯¸
                    const maxWidth = container.offsetWidth - 20; // ç•™é‚Šè·
                    const maxHeight = container.offsetHeight - 20;
                    
                    let newWidth = img.width;
                    let newHeight = img.height;
                    
                    // ç¸®æ”¾é‚è¼¯ï¼šç¢ºä¿åœ–ç‰‡å®Œæ•´é¡¯ç¤ºåœ¨è¢å¹•å…§
                    const ratio = Math.min(maxWidth / newWidth, maxHeight / newHeight);
                    
                    newWidth = newWidth * ratio;
                    newHeight = newHeight * ratio;

                    // é‡è¨­ç•«å¸ƒå¤§å°
                    resizeCanvas(newWidth, newHeight);

                    // è¨­å®šèƒŒæ™¯åœ–
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                        scaleX: ratio,
                        scaleY: ratio,
                        originX: 'left',
                        originY: 'top'
                    });
                });
            };
            reader.readAsDataURL(file);
        });

        // B. åŠ å…¥æ–‡å­—
        function addText() {
            const text = new fabric.IText('é›™æ“Šç·¨è¼¯', {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontFamily: 'Noto Sans TC',
                fill: '#ffffff',
                stroke: '#000000',
                strokeWidth: 1, // æ–‡å­—æé‚Šï¼Œè®“å®ƒåœ¨åœ–ç‰‡ä¸Šæ›´æ¸…æ¥š
                fontSize: 40,
                originX: 'center',
                originY: 'center'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // C. åŠ å…¥ Emoji è²¼åœ–
        function addEmoji(emoji) {
            const text = new fabric.Text(emoji, {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontSize: 60,
                originX: 'center',
                originY: 'center',
                selectable: true
            });
            canvas.add(text);
            toggleStickerMenu(); // é¸å®Œé—œé–‰é¸å–®
        }

        // D. ä¸Šå‚³è‡ªå®šç¾©è²¼åœ– (åœ–ç‰‡)
        document.getElementById('sticker-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    // ç¸®æ”¾ä¸€ä¸‹è²¼åœ–ï¼Œé¿å…å¤ªå¤§è“‹ä½æ•´å€‹ç•«é¢
                    const scaleFactor = 100 / img.width; 
                    
                    img.set({
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        originX: 'center',
                        originY: 'center',
                        scaleX: scaleFactor,
                        scaleY: scaleFactor
                    });
                    canvas.add(img);
                    canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(file);
        });

        // E. åˆªé™¤é¸å–ç‰©ä»¶
        function deleteSelected() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.remove(activeObject);
                canvas.discardActiveObject();
                canvas.requestRenderAll();
            }
        }

        // F. åˆ‡æ›è²¼åœ–é¸å–®é¡¯ç¤º
        function toggleStickerMenu() {
            const menu = document.getElementById('sticker-menu');
            menu.classList.toggle('hidden');
        }

        // G. ä¸‹è¼‰åœ–ç‰‡
        function downloadImage() {
            // å–æ¶ˆé¸å–ç‹€æ…‹ï¼Œé¿å…é¸å–æ¡†è¢«å°å‡ºä¾†
            canvas.discardActiveObject();
            canvas.renderAll();

            if (!canvas.backgroundImage) {
                alert('è«‹å…ˆä¸Šå‚³ç…§ç‰‡ä½œç‚ºèƒŒæ™¯ï¼');
                return;
            }

            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 2 // ä¸‹è¼‰ 2 å€é«˜ç•«è³ª
            });

            const link = document.createElement('a');
            link.download = 'edited-photo-' + Date.now() + '.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // è¦–çª—æ”¹è®Šå¤§å°æ™‚é‡æ–°è¨ˆç®—å®¹å™¨ (é¸ç”¨ï¼Œæ‰‹æ©Ÿæ—‹è½‰æ™‚å¯èƒ½éœ€è¦)
        window.addEventListener('resize', function() {
           // é€™è£¡å¯ä»¥åŠ å…¥é‡æ–°è¨ˆç®—ç•«å¸ƒä½ç½®çš„é‚è¼¯ï¼Œ
           // ä½† Fabric.js æ”¹è®Šç•«å¸ƒå¤§å°æœƒè£åˆ‡å…§å®¹ï¼Œç°¡å–®ç‰ˆæš«ä¸å¯¦ä½œè¤‡é›œé‡ç¹ªã€‚
        });

    </script>
</body>
</html>