<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>光學物理實驗室-烏衣行</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app">
    <div class="top-bar">
        <button v-if="view !== 'menu'" @click="goHome" class="flex items-center gap-2 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm font-bold transition">
            <span>⬅ 選單</span>
        </button>
        <div v-else class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-400">
            烏衣行 光學物理實驗室
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2 text-sm md:text-base font-bold text-slate-200 pointer-events-none whitespace-nowrap overflow-hidden text-ellipsis max-w-[50%]">
            {{ headerText }}
        </div>

        <div v-if="view === 'game'" class="flex gap-3 text-sm font-mono">
            <span class="text-cyan-300">Lv {{ game.level }}/5</span>
            <span class="text-yellow-400">Score: {{ game.score }}</span>
        </div>
        
        <div v-if="view === 'hunter'" class="flex gap-3 text-sm font-mono">
            <span class="text-red-400">HITS: {{ hunter.score }}</span>
        </div>

        <div v-if="view === 'sandbox'" class="text-xs text-slate-400">
            鏡子: {{ sandbox.mirrors.length }}/6
        </div>
    </div>

    <div class="canvas-area" ref="containerRef">
        <canvas ref="canvasRef"
            :class="{ interactive: view !== 'menu' }"
            @mousedown="handleStart"
            @mousemove="handleMove"
            @mouseup="handleEnd"
            @mouseleave="handleEnd"
            @touchstart.prevent="handleStart"
            @touchmove.prevent="handleMove"
            @touchend="handleEnd">
        </canvas>

        <div v-if="view === 'sim' && simParams.type === 'refraction'" 
             class="absolute top-[62%] left-4 z-40 flex flex-col gap-3 select-none">
            <label v-for="(info, key) in mediaOptions" :key="key" 
                   class="flex items-center gap-2 cursor-pointer group opacity-90 hover:opacity-100 transition">
                <input type="checkbox" :value="key" v-model="simParams.activeMedia" 
                       class="w-5 h-5 cursor-pointer rounded border-slate-500 bg-slate-700/50"
                       :style="{ accentColor: info.color }">
                <span class="font-bold text-sm tracking-wide" 
                      :style="{ color: info.color, textShadow: '0 2px 4px rgba(0,0,0,0.8)' }">
                    {{ info.name }}
                </span>
            </label>
        </div>

        <div v-if="view === 'lens'" class="absolute top-4 left-4 z-40 flex flex-col gap-4">
            <div class="bg-slate-800/90 p-1.5 rounded-lg border border-slate-600 flex gap-1 backdrop-blur-sm">
                <button @click="lensParams.type = 'convex'" 
                    class="px-4 py-2 rounded text-sm font-bold transition"
                    :class="lensParams.type === 'convex' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'">
                    凸透鏡
                </button>
                <button @click="lensParams.type = 'concave'" 
                    class="px-4 py-2 rounded text-sm font-bold transition"
                    :class="lensParams.type === 'concave' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'">
                    凹透鏡
                </button>
            </div>
        </div>

        <div v-if="view === 'lens'" class="absolute bottom-4 left-4 z-40 bg-slate-900/90 border border-slate-700 p-4 rounded-xl shadow-xl backdrop-blur-md min-w-[240px]">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3 border-b border-slate-700 pb-2">即時數據</h3>
            <div class="grid grid-cols-[1fr_auto] gap-y-2 text-sm font-mono">
                <span class="text-slate-300">焦距 (f):</span>
                <span class="text-green-400 font-bold text-right">{{ Math.abs(Math.round(lensParams.f)) }} cm</span>
                
                <span class="text-slate-300">物距 (do):</span>
                <span class="text-blue-400 font-bold text-right">{{ Math.round(lensParams.objDist) }} cm</span>
                
                <span class="text-slate-300">像距 (di):</span>
                <span class="text-purple-400 font-bold text-right">{{ Math.abs(Math.round(lensData.di)) }} cm</span>
                
                <span class="text-slate-300">放大率 (M):</span>
                <span class="text-yellow-400 font-bold text-right">{{ Math.abs(lensData.m).toFixed(2) }}x</span>
            </div>
            
            <div class="mt-3 pt-2 border-t border-slate-700 text-center font-bold text-sm"
                 :class="lensData.isReal ? 'text-orange-400' : 'text-cyan-400'">
                {{ lensData.desc }}
            </div>
        </div>

        <div v-if="view === 'hunter'" class="absolute bottom-6 right-6 z-40 flex flex-col items-center gap-2">
            <button @click="fireHunterRay" :disabled="hunter.isFiring" class="fire-btn" :class="{'opacity-50 cursor-not-allowed': hunter.isFiring, 'animate-pulse': !hunter.isFiring}">
                <span class="text-2xl">🔥</span>
            </button>
            <div class="text-xs text-slate-400 font-mono select-none font-bold bg-black/30 px-2 rounded">FIRE</div>
        </div>

        <div v-if="view === 'sandbox'" class="sandbox-controls">
            <button class="icon-btn" @click="toggleSandboxLight" :class="sandbox.source.isOn ? 'text-yellow-400' : 'text-slate-500'">
                <span>{{ sandbox.source.isOn ? '☀' : '☾' }}</span>
                <div>光源{{ sandbox.source.isOn ? '開' : '關' }}</div>
            </button>
            <div class="w-px h-8 bg-slate-600"></div>
            <button class="icon-btn" @click="addMirror" :disabled="sandbox.mirrors.length >= 6">
                <span class="text-green-400">＋</span>
                <div>加鏡子</div>
            </button>
            <button class="icon-btn" @click="removeMirror" :disabled="sandbox.mirrors.length <= 0">
                <span class="text-red-400">－</span>
                <div>移除</div>
            </button>
        </div>

        <transition name="fade">
            <div v-if="view === 'game' && game.level === 1 && game.state === 'playing' && showGameHint" class="absolute top-20 left-1/2 transform -translate-x-1/2 pointer-events-none z-40">
                <div class="bg-black/60 px-6 py-2 rounded-full backdrop-blur border border-yellow-500/30 text-yellow-300 font-bold shadow-lg">
                    點擊 A、B、C 圓點作答
                </div>
            </div>
        </transition>

        <div v-if="view === 'game' && game.state === 'result'" class="result-box">
            <div class="flex items-start gap-3">
                <span class="text-3xl mt-1">{{ game.lastCorrect ? '✅' : '❌' }}</span>
                <div>
                    <div class="text-lg font-bold" :class="game.lastCorrect ? 'text-green-400' : 'text-red-400'">
                        {{ game.lastCorrect ? '答對了！' : '答錯了' }}
                    </div>
                    <div class="text-xs text-slate-300 mt-2 leading-relaxed">
                        {{ game.type === 'refraction' ? '提示：光從空氣進入水中，路徑偏向法線。' : '提示：入射角等於反射角。' }}
                    </div>
                </div>
            </div>
        </div>

        <button v-if="view === 'game' && game.state === 'result'" @click="nextLevel" class="next-btn hover:bg-blue-400">
            {{ game.level >= 5 ? '查看成績' : '下一題' }} ➡
        </button>

        <div v-if="view === 'game' && game.state === 'summary'" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-50">
            <div class="text-7xl mb-4">🏆</div>
            <h2 class="text-3xl font-bold mb-2">挑戰完成</h2>
            <div class="text-xl text-slate-400 mb-8">得分：<span class="text-yellow-400 font-bold text-4xl">{{ game.score }}</span></div>
            <button @click="goHome" class="px-10 py-3 bg-slate-600 rounded-xl font-bold text-lg border border-slate-500 hover:bg-slate-500">
                返回選單
            </button>
        </div>
    </div>

    <div v-if="view === 'menu'" class="menu-overlay">
        <div class="menu-grid">
            
            <div class="menu-col">
                <h2 class="text-slate-400 text-sm font-bold uppercase tracking-widest mb-2">實驗與模擬</h2>


                <button @click="startSim('reflection')" class="btn-card hover:border-purple-400">
                    <span class="text-4xl">🪞</span>
                    <div>
                        <div class="font-bold text-xl text-purple-400">反射模擬</div>
                        <div class="text-sm text-slate-400">單一鏡面 · 驗證反射定律</div>
                    </div>
                </button>

                <button @click="startSim('refraction')" class="btn-card hover:border-cyan-400">
                    <span class="text-4xl">🌊</span>
                    <div>
                        <div class="font-bold text-xl text-cyan-400">折射模擬</div>
                        <div class="text-sm text-slate-400">單一光源 · 觀察水下折射</div>
                    </div>
                </button>

                <button @click="startSandbox" class="btn-card bg-slate-800 hover:border-white border-dashed border-2 border-slate-600">
                    <span class="text-4xl">🛠</span>
                    <div>
                        <div class="font-bold text-xl text-white">多鏡反射沙盒</div>
                        <div class="text-sm text-slate-400">自由放置鏡子 · 改變光線</div>
                    </div>
                </button>

                
                <button @click="startLens" class="btn-card hover:border-blue-400 border border-transparent bg-slate-800">
                    <span class="text-4xl">🔍</span>
                    <div>
                        <div class="font-bold text-xl text-blue-400">透鏡成像</div>
                        <div class="text-sm text-slate-400">凸透鏡 · 凹透鏡 · 光路圖</div>
                    </div>
                </button>
            </div>

            <div class="menu-col">
                <h2 class="text-slate-400 text-sm font-bold uppercase tracking-widest mb-2">測驗挑戰</h2>

                <button @click="startHunter" class="btn-card bg-slate-800 hover:border-red-500 border border-slate-700">
                    <span class="text-4xl">👾</span>
                    <div>
                        <div class="font-bold text-xl text-red-400">反射獵人</div>
                        <div class="text-sm text-slate-400">調整光源與鏡子 · 擊中怪物</div>
                    </div>
                </button>
                
                <button @click="startGame('reflection')" class="btn-card bg-slate-800 hover:border-green-400">
                    <span class="text-4xl">📐</span>
                    <div>
                        <div class="font-bold text-xl text-green-400">反射測驗</div>
                        <div class="text-sm text-slate-400">5個關卡 · 預測落點</div>
                    </div>
                </button>

                <button @click="startGame('refraction')" class="btn-card bg-slate-800 hover:border-yellow-400">
                    <span class="text-4xl">⚡</span>
                    <div>
                        <div class="font-bold text-xl text-yellow-400">折射測驗</div>
                        <div class="text-sm text-slate-400">5個關卡 · 預測路徑</div>
                    </div>
                </button>
            </div>
            
        </div>
    </div>
</div>

<script src="script.js"></script>
</body>
</html>