<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹è¨€éŸ³ç´ æ¯”å°ç³»çµ± (AI Powered)</title>
    <style>
        :root {
            --primary: #4a90e2;
            --success: #2ecc71;
            --danger: #e74c3c;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
        }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        p.subtitle { text-align: center; color: #7f8c8d; margin-top: 0; }

        /* å¡ç‰‡æ¨£å¼ */
        .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        h2 { margin-top: 0; font-size: 1.2rem; border-left: 4px solid var(--primary); padding-left: 10px; color: #34495e; }
        
        /* IPA é¡¯ç¤ºå€ */
        .ipa-box { 
            background: #ecf0f1; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: "Courier New", monospace; 
            font-weight: bold; 
            font-size: 1.2rem; 
            min-height: 24px;
            margin-top: 10px;
            letter-spacing: 1px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #bdc3c7;
        }
        .ipa-box.active { border-style: solid; border-color: var(--primary); background: #eaf2f8; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .controls { display: flex; gap: 10px; margin-top: 15px; }
        button { 
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; 
            font-size: 1rem; font-weight: bold; transition: 0.3s; flex: 1;
        }
        .btn-upload { background: #34495e; color: white; }
        .btn-record { background: var(--danger); color: white; }
        .btn-compare { background: var(--success); color: white; width: 100%; padding: 15px; font-size: 1.3rem; margin-top: 10px; }
        
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        button:active { transform: scale(0.98); }
        
        /* éŒ„éŸ³å‹•ç•« */
        .recording-pulse { animation: pulse 1.5s infinite; background: #c0392b; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* çµæœé¡¯ç¤ºå€ */
        #resultArea { display: none; text-align: center; margin-top: 20px; padding: 20px; background: #fff; border-radius: 12px; border: 2px solid var(--success); }
        .score { font-size: 3.5rem; font-weight: bold; margin: 10px 0; color: var(--success); }
        .details { color: #7f8c8d; font-size: 0.9rem; }
        
        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loader { display: inline-block; width: 12px; height: 12px; border: 2px solid #333; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 5px;}
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-msg { font-size: 0.85rem; color: #e67e22; margin-top: 5px; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h1>ç™¼éŸ³æ¯”å°æ©Ÿ</h1>
    <p class="subtitle">AI æŠ€è¡“æ”¯æ´ï¼šIPA åœ‹éš›éŸ³æ¨™è¾¨è­˜</p>

    <div class="card">
        <h2>1. è€å¸«ç¤ºç¯„ (Standard)</h2>
        <p style="font-size:0.9em; color:#666;">è«‹ä¸Šå‚³æ¨™æº–ç™¼éŸ³æª” (mp3/wav)</p>
        <div class="controls">
            <input type="file" id="refFile" accept="audio/*" style="display:none">
            <button class="btn-upload" onclick="document.getElementById('refFile').click()">ğŸ“‚ é¸æ“‡éŸ³æª”</button>
        </div>
        <div id="refIPA" class="ipa-box">ç­‰å¾…è¼¸å…¥...</div>
        <div id="refStatus" class="status-msg"></div>
    </div>

    <div class="card">
        <h2>2. ä½ çš„ç™¼éŸ³ (Practice)</h2>
        <p style="font-size:0.9em; color:#666;">è«‹æŒ‰ä½æŒ‰éˆ•éŒ„éŸ³</p>
        <div class="controls">
            <button id="recordBtn" class="btn-record">ğŸ™ï¸ æŒ‰ä½éŒ„éŸ³</button>
        </div>
        <div id="userIPA" class="ipa-box">ç­‰å¾…éŒ„éŸ³...</div>
        <div id="userStatus" class="status-msg"></div>
    </div>

    <button class="btn-compare" onclick="calculateScore()">ğŸ“Š è¨ˆç®—ç›¸ä¼¼åº¦</button>

    <div id="resultArea">
        <div>ç™¼éŸ³æº–ç¢ºåº¦</div>
        <div class="score" id="scoreVal">--</div>
        <div class="details" id="scoreDesc"></div>
        <div style="margin-top:15px; font-size:0.8em; background:#f9f9f9; padding:10px; border-radius:5px; text-align:left;">
            <strong>è¨ºæ–·å ±å‘Šï¼š</strong><br>
            è€å¸«éŸ³æ¨™ï¼š<span id="resRef" style="color:var(--primary)">--</span><br>
            å­¸ç”ŸéŸ³æ¨™ï¼š<span id="resUser" style="color:var(--danger)">--</span><br>
            å·®ç•°è·é›¢ï¼š<span id="resDist">--</span> (æ•¸å€¼è¶Šå°è¶Šæº–)
        </div>
    </div>
</div>

<script>
    // ==========================================
    // è¨­å®šå€ï¼šä½ çš„å¾Œç«¯ç¶²å€
    // ==========================================
    const API_URL = "https://wskone-kasu-api.hf.space/recognize";

    // å…¨åŸŸè®Šæ•¸
    let refIPA = "";
    let userIPA = "";
    let mediaRecorder;
    let chunks = [];

    // --- 1. è™•ç†è€å¸«æª”æ¡ˆä¸Šå‚³ ---
    document.getElementById('refFile').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        updateUI('refIPA', 'refStatus', 'è™•ç†ä¸­...', 'ä¸Šå‚³ä¸¦åˆ†æä¸­ (é¦–æ¬¡å•Ÿå‹•å¯èƒ½éœ€ 30-60 ç§’)...');
        
        const ipa = await sendToBackend(file);
        if (ipa) {
            refIPA = ipa;
            updateUI('refIPA', 'refStatus', ipa, 'åˆ†æå®Œæˆ', true);
        } else {
            updateUI('refIPA', 'refStatus', 'å¤±æ•—', 'ç„¡æ³•è¾¨è­˜æˆ–ä¼ºæœå™¨éŒ¯èª¤', false);
        }
    });

    // --- 2. è™•ç†å­¸ç”ŸéŒ„éŸ³ ---
    const recordBtn = document.getElementById('recordBtn');

    // åˆå§‹åŒ–éº¥å…‹é¢¨
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/webm' }); // Chrome é è¨­
            chunks = [];
            const file = new File([blob], "record.webm", { type: "audio/webm" });

            updateUI('userIPA', 'userStatus', 'åˆ†æä¸­...', 'æ­£åœ¨å‚³é€è‡³ AI ä¼ºæœå™¨...');
            
            const ipa = await sendToBackend(file);
            if (ipa) {
                userIPA = ipa;
                updateUI('userIPA', 'userStatus', ipa, 'åˆ†æå®Œæˆ', true);
            } else {
                updateUI('userIPA', 'userStatus', 'å¤±æ•—', 'ç„¡æ³•è¾¨è­˜', false);
            }
        };
    }).catch(e => {
        alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ˜¯å¦æœ‰æ¬Šé™ (éœ€ä½¿ç”¨ HTTPS æˆ– Localhost)");
        console.error(e);
    });

    // æŒ‰éˆ•äº‹ä»¶
    recordBtn.addEventListener('mousedown', () => {
        if(mediaRecorder && mediaRecorder.state === 'inactive') {
            mediaRecorder.start();
            recordBtn.classList.add('recording-pulse');
            recordBtn.innerText = "æ”¾é–‹çµæŸ...";
            document.getElementById('userIPA').innerText = "éŒ„éŸ³ä¸­...";
        }
    });

    recordBtn.addEventListener('mouseup', () => {
        if(mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            recordBtn.classList.remove('recording-pulse');
            recordBtn.innerText = "ğŸ™ï¸ æŒ‰ä½éŒ„éŸ³";
        }
    });
    // æ‰‹æ©Ÿè§¸æ§æ”¯æ´
    recordBtn.addEventListener('touchstart', (e) => { e.preventDefault(); recordBtn.dispatchEvent(new Event('mousedown')); });
    recordBtn.addEventListener('touchend', (e) => { e.preventDefault(); recordBtn.dispatchEvent(new Event('mouseup')); });


    // --- 3. èˆ‡å¾Œç«¯æºé€š (API Fetch) ---
    async function sendToBackend(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            return data.ipa; // æˆåŠŸå›å‚³ IPA å­—ä¸²
        } catch (err) {
            console.error(err);
            return null;
        }
    }

    // --- 4. è¼”åŠ©åŠŸèƒ½ï¼šæ›´æ–°ä»‹é¢ ---
    function updateUI(boxId, statusId, text, statusText, isSuccess = null) {
        const box = document.getElementById(boxId);
        const status = document.getElementById(statusId);
        
        if (text === 'è™•ç†ä¸­...' || text === 'åˆ†æä¸­...') {
            box.innerHTML = `<span class="loader"></span> ${text}`;
            box.classList.remove('active');
        } else {
            box.innerText = text;
            if(isSuccess) box.classList.add('active');
        }
        status.innerText = statusText;
    }

    // --- 5. æ ¸å¿ƒæ¼”ç®—æ³•ï¼šç·¨è¼¯è·é›¢ (Levenshtein Distance) ---
    function levenshtein(a, b) {
        if(!a || !b) return 0;
        // ç§»é™¤ IPA ä¸­çš„ç©ºæ ¼ä»¥ä¾¿æ¯”å°ç¬¦è™Ÿæœ¬èº«
        const s = a.replace(/\s+/g, '');
        const t = b.replace(/\s+/g, '');
        
        const d = [];
        for (let i = 0; i <= s.length; i++) d[i] = [i];
        for (let j = 0; j <= t.length; j++) d[0][j] = j;

        for (let i = 1; i <= s.length; i++) {
            for (let j = 1; j <= t.length; j++) {
                const cost = s[i-1] === t[j-1] ? 0 : 1;
                d[i][j] = Math.min(
                    d[i-1][j] + 1,      // åˆªé™¤
                    d[i][j-1] + 1,      // æ’å…¥
                    d[i-1][j-1] + cost  // æ›¿æ›
                );
            }
        }
        return d[s.length][t.length];
    }

    // --- 6. è¨ˆç®—ä¸¦é¡¯ç¤ºåˆ†æ•¸ ---
    function calculateScore() {
        if (!refIPA || !userIPA) {
            alert("è«‹å…ˆå®Œæˆ è€å¸«éŸ³æª”ä¸Šå‚³ èˆ‡ å­¸ç”ŸéŒ„éŸ³ï¼");
            return;
        }

        const dist = levenshtein(refIPA, userIPA);
        const maxLen = Math.max(refIPA.replace(/\s+/g, '').length, userIPA.replace(/\s+/g, '').length);
        
        // åˆ†æ•¸è¨ˆç®—ï¼š (1 - éŒ¯èª¤æ•¸/ç¸½é•·åº¦) * 100
        // è‹¥å®Œå…¨æ²’å­—ï¼Œåˆ†æ•¸ç‚º 0
        let score = maxLen === 0 ? 0 : Math.max(0, ((maxLen - dist) / maxLen) * 100);
        score = Math.round(score);

        // é¡¯ç¤ºçµæœ
        const resultArea = document.getElementById('resultArea');
        const scoreVal = document.getElementById('scoreVal');
        const scoreDesc = document.getElementById('scoreDesc');
        
        resultArea.style.display = 'block';
        scoreVal.innerText = score + " åˆ†";
        
        // è©•èª
        if (score === 100) scoreDesc.innerText = "å¤ªç¥äº†ï¼å®Œå…¨æ­£ç¢ºï¼";
        else if (score >= 80) scoreDesc.innerText = "ç™¼éŸ³éå¸¸æ¨™æº–ï¼Œåªæœ‰ä¸€é»é»å·®ç•°ã€‚";
        else if (score >= 60) scoreDesc.innerText = "é‚„å¯ä»¥ï¼Œè«‹æ³¨æ„æŸäº›éŸ³ç¯€çš„å’¬å­—ã€‚";
        else scoreDesc.innerText = "å·®ç•°è¼ƒå¤§ï¼Œè«‹å†è½ä¸€æ¬¡è€å¸«çš„ç¤ºç¯„ã€‚";

        // é¡è‰²è®ŠåŒ–
        if(score >= 80) scoreVal.style.color = "#2ecc71";
        else if(score >= 60) scoreVal.style.color = "#f39c12";
        else scoreVal.style.color = "#e74c3c";

        // è©³ç´°å ±å‘Š
        document.getElementById('resRef').innerText = refIPA;
        document.getElementById('resUser').innerText = userIPA;
        document.getElementById('resDist').innerText = dist;
    }
</script>

</body>
</html>