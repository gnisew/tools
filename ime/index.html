<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上文字編輯器</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="ime.css">
	<link href="https://tauhu.tw/tauhu-oo.css" rel="stylesheet">
	<link href="https://tauhu.tw/tauhu-mootng.css" rel="stylesheet">
	<link href="https://oikasu1.github.io/kasuexam/kasu/fonts/twhei.css" rel="stylesheet">
	<link rel="stylesheet" href="https://oikasu1.github.io/fonts/twfonts.css">

    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            background: #f3f2f1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
		.main-controls-container {
			display: flex;
			flex-wrap: wrap; /* 核心屬性：允許內容在空間不足時換行 */
			align-items: center; /* 讓不同高度的元件在垂直方向上置中對齊 */
			background: #ffffff;
			border-bottom: 1px solid #d1d1d1;
			padding: 0 8px; /* 為容器增加左右內邊距 */
			gap: 8px; /* 在選單列與工具列之間增加一些間距 */
		}
		.header {
			background: #ffffff;
			border-bottom: none; /* 移除原始的底部邊線 */
			padding: 8px 16px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			box-shadow: none; /* 移除原始的陰影 */
			flex-shrink: 0; /* 防止選單列在空間不足時被過度壓縮 */
		}

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            overflow: hidden;
        }

        .menu-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            padding: 0 8px;
            flex: 1;
            position: relative;
        }

        .menu-toggle-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #323130;
            transition: background 0.2s;
            flex-shrink: 0;
            margin-right: 8px;
        }

        .menu-toggle-btn:hover {
            background: #f3f2f1;
        }

        .menu-items {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            flex: 1;
        }

        .more-menu {
            position: relative;
        }

        .more-btn {
            padding: 12px 8px;
            cursor: pointer;
            color: #323130;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            background: none;
            border: none;
            display: none;
        }

        .more-btn:hover {
            background: #f3f2f1;
            border-bottom-color: #0078d4;
        }

        .more-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }

        .more-dropdown .menu-item {
            display: block;
            padding: 12px 16px;
            border-bottom: none;
            border-radius: 0;
        }

        .more-dropdown .menu-item:hover {
            background: #f3f2f1;
        }

        @media (max-width: 1024px) {
            .menu-bar {
                width: 100%;
            }
        }

        .menu-item {
            padding: 12px 8px;
            cursor: pointer;
            color: #323130;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .menu-item:hover {
            background: #f3f2f1;
            border-bottom-color: #0078d4;
        }

        .menu-item.active {
            border-bottom-color: #0078d4;
            color: #0078d4;
        }

		.toolbar {
			background: #ffffff;
			border-bottom: none; /* 移除原始的底部邊線 */
			padding: 8px 16px;
			display: flex;
			align-items: center;
			gap: 4px;
			flex-wrap: wrap;
			flex-grow: 1; /* 允許工具列佔據剩餘的空間 */
		}

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid #d1d1d1;
            margin-right: 8px;
        }

        .toolbar-group:last-child {
            border-right: none;
            margin-right: 0;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #323130;
            transition: background 0.2s;
        }

        .toolbar-btn:hover {
            background: #f3f2f1;
        }

        .toolbar-btn.active {
            background: #deecf9;
            color: #0078d4;
        }

        .font-select, .size-select {
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .font-select {
            width: 120px;
        }

        .size-select {
            width: 60px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

		.editor-container {
			flex: 1;
			padding-top: 20px;
			padding-bottom: 20px;
			display: flex;
			justify-content: center;
			overflow: auto;
		}

        .editor {
            width: 100%;
            max-width: 800px;
            height: calc(100vh - 240px);
            background: white;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            padding: 40px 20px;
            font-size: 18px;
            line-height: 1.6;
            font-family: "台灣黑體", 'tauhu-oo', serif;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            resize: none;
        }

        .status-bar {
            background: #ffffff;
            border-top: 1px solid #d1d1d1;
            padding: 8px 16px;
            font-size: 12px;
            color: #605e5c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            min-width: 300px;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #323130;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .btn-primary:hover {
            background: #106ebe;
        }

        .btn:hover {
            background: #f3f2f1;
        }

        .find-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            border: 1px solid #d1d1d1;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 350px;
            user-select: none;
        }

        .find-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #d1d1d1;
            border-radius: 8px 8px 0 0;
            cursor: move;
        }

        .drag-handle {
            color: #666;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
        }

        .close-btn:hover {
            background: #e9ecef;
        }

        .find-panel-content {
            padding: 16px;
        }

        .find-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .find-row label {
            width: 40px;
            font-size: 14px;
            color: #323130;
        }

        .find-row input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            font-size: 14px;
        }

        .find-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d1d1;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .find-btn:hover {
            background: #f3f2f1;
        }

        .find-options {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
            font-size: 13px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }



        .highlight {
            background-color: #ffeb3b;
            color: #000;
        }

        .current-match {
            background-color: #ff9800;
            color: #fff;
        }



        .editor-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
			padding-left: 20px;
			padding-right: 20px;
        }

        .selection-highlight {
            background-color: rgba(0, 120, 212, 0.2);
            border: 1px solid #0078d4;
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }

        .toolbar-btn-text {
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 8px;
            font-size: 14px;
            color: #323130;
            transition: background 0.2s;
        }

        .toolbar-btn-text:hover {
            background: #f3f2f1;
        }

        .toolbar-btn-text.active {
            background: #deecf9;
            color: #0078d4;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            position: relative;
        }

        .dropdown-arrow {
            font-size: 16px !important;
            margin-left: 4px;
            transition: transform 0.2s;
        }

        .dropdown-toggle.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 180px;
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .dropdown-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #323130;
            border-bottom: 1px solid #f3f2f1;
            transition: background 0.2s;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f3f2f1;
        }

        .dropdown-item:first-child {
            border-radius: 4px 4px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 4px 4px;
        }

        .dictionary-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            border-left: 1px solid #d1d1d1;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .dictionary-sidebar.open {
            right: 0;
        }



        .dictionary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #d1d1d1;
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dictionary-title {
            font-size: 18px;
            font-weight: 600;
            color: #323130;
        }

        .dictionary-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
        }

        .dictionary-close:hover {
            background: #e9ecef;
        }

        .dictionary-content {
            padding: 20px;
        }

        .dictionary-search {
            margin-bottom: 20px;
        }

        .search-input-group {
            display: flex;
            gap: 8px;
        }

        .search-input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #d1d1d1;
            background: #0078d4;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .search-btn:hover {
            background: #106ebe;
        }

        .dictionary-results {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .dictionary-entry {
            padding: 16px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fafafa;
        }

        .dictionary-word {
            font-size: 18px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 8px;
        }

        .dictionary-pronunciation {
            font-size: 14px;
            color: #0078d4;
            font-family: monospace;
            margin-bottom: 8px;
        }

        .dictionary-definition {
            font-size: 14px;
            color: #605e5c;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .dictionary-example {
            font-size: 13px;
            color: #666;
            font-style: italic;
            padding: 8px 12px;
            background: #f3f2f1;
            border-radius: 4px;
            border-left: 3px solid #0078d4;
        }

        .dictionary-placeholder {
            text-align: center;
            padding: 40px 20px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            border-right: 1px solid #d1d1d1;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #d1d1d1;
            background: #f8f9fa;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #323130;
        }

        .sidebar-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
        }

        .sidebar-close:hover {
            background: #e9ecef;
        }

        .sidebar-content {
            padding: 20px;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #323130;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .settings-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            min-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #323130;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        @media (max-width: 768px) {
            .toolbar {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .editor {
                padding: 20px;
                font-size: 16px;
            }
            
            .menu-bar {
                padding: 0 8px;
                gap: 12px;
            }
            
            .toolbar {
                padding: 8px;
            }

            .find-panel {
                right: 10px;
                left: 10px;
                min-width: auto;
				width: auto;
            }
            .find-row input {
                min-width: 0;
            }
            .toolbar-btn-text .btn-text {
                display: none;
            }

            .settings-content {
                min-width: 300px;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="main-controls-container">
    <div class="header">
        <div class="header-content">
            <div class="menu-bar">
                <button class="menu-toggle-btn" onclick="toggleSidebar()" title="選單">
                    <span class="material-icons">menu</span>
                </button>
                <div class="menu-items" id="menuItems">
                    <div class="menu-item active" onclick="switchTab('home')">🥷烏衣行</div>
					<!--
                    <div class="menu-item" onclick="switchTab('sixian')" id="menu-sixian">四縣</div>
                    <div class="menu-item" onclick="switchTab('hailu')" id="menu-hailu">海陸</div>
                    <div class="menu-item" onclick="switchTab('dabu')" id="menu-dabu">大埔</div>
                    <div class="menu-item" onclick="switchTab('raoping')" id="menu-raoping">饒平</div>
                    <div class="menu-item" onclick="switchTab('zhaoan')" id="menu-zhaoan">詔安</div>
                    <div class="menu-item" onclick="switchTab('hele')" id="menu-hele">和樂</div>
                    <div class="menu-item" onclick="switchTab('matsu')" id="menu-matsu">馬祖</div>
					-->
                </div>
                <div class="more-menu">
                    <button class="more-btn" id="moreBtn" onclick="toggleMoreMenu()">
                        更多 <span class="material-icons" style="font-size: 16px;">expand_more</span>
                    </button>
                    <div class="more-dropdown" id="moreDropdown"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toolbar" id="homeToolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" id="autoSaveBtn" onclick="toggleAutoSave()" title="自動儲存"><span class="material-icons">cloud_sync</span></button>

        </div>
		<div class="toolbar-group">
			<button class="toolbar-btn-text ime-toggle-button" title="輸入法">
				<span class="material-icons">keyboard</span>
				<span class="btn-text">輸入法</span>
			</button>
			
		</div>
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="copyText()" title="複製"><span class="material-icons">content_copy</span></button>
            <button class="toolbar-btn" onclick="cutText()" title="剪下"><span class="material-icons">content_cut</span></button>
            <button class="toolbar-btn" onclick="selectAll()" title="全選"><span class="material-icons">select_all</span></button>
            <button class="toolbar-btn" onclick="findReplace()" title="尋找與取代"><span class="material-icons">search</span></button>
        </div>
        
        <div class="toolbar-group">
            <select class="size-select" id="fontSize" onchange="changeFontSize()">
                <option value="12">12</option>
                <option value="14">14</option>
                <option value="16">16</option>
                <option value="18" selected>18</option>
                <option value="20">20</option>
                <option value="24">24</option>
				<option value="32">32</option>
            </select>
            <select class="font-select" id="fontFamily" onchange="changeFontFamily()">
			    <option value="'twhei-s', 'TWHEI', '台灣黑體'">黑體</option>
			    <option value="tauhu-oo">豆腐黑體</option>
			    <option value="台灣楷體">台灣楷體</option>
				<option value="台灣宋體">台灣宋體</option>
				<option value="TaigiKaiStd-TL-R">字咍標楷</option>	
				<option value="TaigiGenSekiG-TL-R">字咍黑體</option>	
				<option value="TaigiKaiStd-TLHI-R">字咍台羅方音</option>
				<option value="EngTRESSA">EngTRESS-A</option>
				<option value="EngTRESSB">EngTRESS-B</option>


            </select>
        </div>
    </div>






    <div class="toolbar" id="sixianToolbar" style="display: none;">
        <div class="toolbar-group">
            <button class="toolbar-btn-text ime-toggle-button" title="輸入法">
                <span class="material-icons">keyboard</span>
                <span class="btn-text">輸入法</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToHakka('sixian')" title="華轉客">
                <span class="material-icons">language</span>
                <span class="btn-text">華轉客</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToMandarin('sixian')" title="客轉華">
                <span class="material-icons">language</span>
                <span class="btn-text">客轉華</span>
            </button>
            <button class="toolbar-btn-text" onclick="toPinyin('sixian')" title="轉拼音">
                <span class="material-icons">translate</span>
                <span class="btn-text">轉拼音</span>
            </button>
            <div class="dropdown">
                <button class="toolbar-btn-text dropdown-toggle" onclick="togglePinyinDropdown('sixian')" title="拼音轉換">
                    <span class="material-icons">text_rotation_none</span>
                    <span class="btn-text">拼音轉換</span>
                    <span class="material-icons dropdown-arrow">expand_more</span>
                </button>
                <div class="dropdown-menu" id="pinyinDropdown-sixian">
                    <div class="dropdown-item" onclick="convertPinyin('sixian', 'number-to-tone')">數字調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('sixian', 'tone-to-number')">字尾調轉數字調</div>
                    <div class="dropdown-item" onclick="convertPinyin('sixian', 'letter-to-tone')">字母調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('sixian', 'tone-to-letter')">字尾調轉字母調</div>
                </div>
            </div>
            <button class="toolbar-btn-text" onclick="searchDictionary('sixian')" title="查辭典">
                <span class="material-icons">book</span>
                <span class="btn-text">查辭典</span>
            </button>
        </div>
    </div>

    <div class="toolbar" id="hailuToolbar" style="display: none;">
        <div class="toolbar-group">
            <button class="toolbar-btn-text ime-toggle-button" title="輸入法">
                <span class="material-icons">keyboard</span>
                <span class="btn-text">輸入法</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToHakka('hailu')" title="華轉客">
                <span class="material-icons">language</span>
                <span class="btn-text">華轉客</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToMandarin('hailu')" title="客轉華">
                <span class="material-icons">language</span>
                <span class="btn-text">客轉華</span>
            </button>
            <button class="toolbar-btn-text" onclick="toPinyin('hailu')" title="轉拼音">
                <span class="material-icons">translate</span>
                <span class="btn-text">轉拼音</span>
            </button>
            <div class="dropdown">
                <button class="toolbar-btn-text dropdown-toggle" onclick="togglePinyinDropdown('hailu')" title="拼音轉換">
                    <span class="material-icons">text_rotation_none</span>
                    <span class="btn-text">拼音轉換</span>
                    <span class="material-icons dropdown-arrow">expand_more</span>
                </button>
                <div class="dropdown-menu" id="pinyinDropdown-hailu">
                    <div class="dropdown-item" onclick="convertPinyin('hailu', 'number-to-tone')">數字調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('hailu', 'tone-to-number')">字尾調轉數字調</div>
                    <div class="dropdown-item" onclick="convertPinyin('hailu', 'letter-to-tone')">字母調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('hailu', 'tone-to-letter')">字尾調轉字母調</div>
                </div>
            </div>
            <button class="toolbar-btn-text" onclick="searchDictionary('hailu')" title="查辭典">
                <span class="material-icons">book</span>
                <span class="btn-text">查辭典</span>
            </button>
        </div>
    </div>

    <div class="toolbar" id="dabuToolbar" style="display: none;">
        <div class="toolbar-group">
            <button class="toolbar-btn-text ime-toggle-button" title="輸入法">
                <span class="material-icons">keyboard</span>
                <span class="btn-text">輸入法</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToHakka('dabu')" title="華轉客">
                <span class="material-icons">language</span>
                <span class="btn-text">華轉客</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToMandarin('dabu')" title="客轉華">
                <span class="material-icons">language</span>
                <span class="btn-text">客轉華</span>
            </button>
            <button class="toolbar-btn-text" onclick="toPinyin('dabu')" title="轉拼音">
                <span class="material-icons">translate</span>
                <span class="btn-text">轉拼音</span>
            </button>
            <div class="dropdown">
                <button class="toolbar-btn-text dropdown-toggle" onclick="togglePinyinDropdown('dabu')" title="拼音轉換">
                    <span class="material-icons">text_rotation_none</span>
                    <span class="btn-text">拼音轉換</span>
                    <span class="material-icons dropdown-arrow">expand_more</span>
                </button>
                <div class="dropdown-menu" id="pinyinDropdown-dabu">
                    <div class="dropdown-item" onclick="convertPinyin('dabu', 'number-to-tone')">數字調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('dabu', 'tone-to-number')">字尾調轉數字調</div>
                    <div class="dropdown-item" onclick="convertPinyin('dabu', 'letter-to-tone')">字母調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('dabu', 'tone-to-letter')">字尾調轉字母調</div>
                </div>
            </div>
            <button class="toolbar-btn-text" onclick="searchDictionary('dabu')" title="查辭典">
                <span class="material-icons">book</span>
                <span class="btn-text">查辭典</span>
            </button>
        </div>
    </div>

    <div class="toolbar" id="raopingToolbar" style="display: none;">
        <div class="toolbar-group">
            <button class="toolbar-btn-text ime-toggle-button" title="輸入法">
                <span class="material-icons">keyboard</span>
                <span class="btn-text">輸入法</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToHakka('raoping')" title="華轉客">
                <span class="material-icons">language</span>
                <span class="btn-text">華轉客</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToMandarin('raoping')" title="客轉華">
                <span class="material-icons">language</span>
                <span class="btn-text">客轉華</span>
            </button>
            <button class="toolbar-btn-text" onclick="toPinyin('raoping')" title="轉拼音">
                <span class="material-icons">translate</span>
                <span class="btn-text">轉拼音</span>
            </button>
            <div class="dropdown">
                <button class="toolbar-btn-text dropdown-toggle" onclick="togglePinyinDropdown('raoping')" title="拼音轉換">
                    <span class="material-icons">text_rotation_none</span>
                    <span class="btn-text">拼音轉換</span>
                    <span class="material-icons dropdown-arrow">expand_more</span>
                </button>
                <div class="dropdown-menu" id="pinyinDropdown-raoping">
                    <div class="dropdown-item" onclick="convertPinyin('raoping', 'number-to-tone')">數字調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('raoping', 'tone-to-number')">字尾調轉數字調</div>
                    <div class="dropdown-item" onclick="convertPinyin('raoping', 'letter-to-tone')">字母調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('raoping', 'tone-to-letter')">字尾調轉字母調</div>
                </div>
            </div>
            <button class="toolbar-btn-text" onclick="searchDictionary('raoping')" title="查辭典">
                <span class="material-icons">book</span>
                <span class="btn-text">查辭典</span>
            </button>
        </div>
    </div>

    <div class="toolbar" id="zhaoanToolbar" style="display: none;">
        <div class="toolbar-group">
            <button class="toolbar-btn-text ime-toggle-button" title="輸入法">
                <span class="material-icons">keyboard</span>
                <span class="btn-text">輸入法</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToHakka('zhaoan')" title="華轉客">
                <span class="material-icons">language</span>
                <span class="btn-text">華轉客</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToMandarin('zhaoan')" title="客轉華">
                <span class="material-icons">language</span>
                <span class="btn-text">客轉華</span>
            </button>
            <button class="toolbar-btn-text" onclick="toPinyin('zhaoan')" title="轉拼音">
                <span class="material-icons">translate</span>
                <span class="btn-text">轉拼音</span>
            </button>
            <div class="dropdown">
                <button class="toolbar-btn-text dropdown-toggle" onclick="togglePinyinDropdown('zhaoan')" title="拼音轉換">
                    <span class="material-icons">text_rotation_none</span>
                    <span class="btn-text">拼音轉換</span>
                    <span class="material-icons dropdown-arrow">expand_more</span>
                </button>
                <div class="dropdown-menu" id="pinyinDropdown-zhaoan">
                    <div class="dropdown-item" onclick="convertPinyin('zhaoan', 'number-to-tone')">數字調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('zhaoan', 'tone-to-number')">字尾調轉數字調</div>
                    <div class="dropdown-item" onclick="convertPinyin('zhaoan', 'letter-to-tone')">字母調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('zhaoan', 'tone-to-letter')">字尾調轉字母調</div>
                </div>
            </div>
            <button class="toolbar-btn-text" onclick="searchDictionary('zhaoan')" title="查辭典">
                <span class="material-icons">book</span>
                <span class="btn-text">查辭典</span>
            </button>
        </div>
    </div>

    <div class="toolbar" id="heleToolbar" style="display: none;">
        <div class="toolbar-group">
            <button class="toolbar-btn-text ime-toggle-button" title="輸入法">
                <span class="material-icons">keyboard</span>
                <span class="btn-text">輸入法</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToTaiwanese('hele')" title="華翻台">
                <span class="material-icons">language</span>
                <span class="btn-text">華翻台</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToMandarin('hele')" title="台轉華">
                <span class="material-icons">language</span>
                <span class="btn-text">台轉華</span>
            </button>
            <button class="toolbar-btn-text" onclick="toPinyin('hele')" title="轉拼音">
                <span class="material-icons">translate</span>
                <span class="btn-text">轉拼音</span>
            </button>
            <div class="dropdown">
                <button class="toolbar-btn-text dropdown-toggle" onclick="togglePinyinDropdown('hele')" title="拼音轉換">
                    <span class="material-icons">text_rotation_none</span>
                    <span class="btn-text">拼音轉換</span>
                    <span class="material-icons dropdown-arrow">expand_more</span>
                </button>
                <div class="dropdown-menu" id="pinyinDropdown-hele">
                    <div class="dropdown-item" onclick="convertPinyin('hele', 'number-to-tone')">數字調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('hele', 'tone-to-number')">字尾調轉數字調</div>
                    <div class="dropdown-item" onclick="convertPinyin('hele', 'letter-to-tone')">字母調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('hele', 'tone-to-letter')">字尾調轉字母調</div>
                </div>
            </div>
            <button class="toolbar-btn-text" onclick="searchDictionary('hele')" title="查辭典">
                <span class="material-icons">book</span>
                <span class="btn-text">查辭典</span>
            </button>
        </div>
    </div>

    <div class="toolbar" id="matsuToolbar" style="display: none;">
        <div class="toolbar-group">
            <button class="toolbar-btn-text ime-toggle-button" title="輸入法">
                <span class="material-icons">keyboard</span>
                <span class="btn-text">輸入法</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToFuzhou('matsu')" title="華翻福">
                <span class="material-icons">language</span>
                <span class="btn-text">華翻福</span>
            </button>
            <button class="toolbar-btn-text" onclick="translateToMandarin('matsu')" title="福轉華">
                <span class="material-icons">language</span>
                <span class="btn-text">福轉華</span>
            </button>
            <button class="toolbar-btn-text" onclick="toPinyin('matsu')" title="轉拼音">
                <span class="material-icons">translate</span>
                <span class="btn-text">轉拼音</span>
            </button>
            <div class="dropdown">
                <button class="toolbar-btn-text dropdown-toggle" onclick="togglePinyinDropdown('matsu')" title="拼音轉換">
                    <span class="material-icons">text_rotation_none</span>
                    <span class="btn-text">拼音轉換</span>
                    <span class="material-icons dropdown-arrow">expand_more</span>
                </button>
                <div class="dropdown-menu" id="pinyinDropdown-matsu">
                    <div class="dropdown-item" onclick="convertPinyin('matsu', 'number-to-tone')">數字調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('matsu', 'tone-to-number')">字尾調轉數字調</div>
                    <div class="dropdown-item" onclick="convertPinyin('matsu', 'letter-to-tone')">字母調轉字尾調</div>
                    <div class="dropdown-item" onclick="convertPinyin('matsu', 'tone-to-letter')">字尾調轉字母調</div>
                </div>
            </div>
            <button class="toolbar-btn-text" onclick="searchDictionary('matsu')" title="查辭典">
                <span class="material-icons">book</span>
                <span class="btn-text">查辭典</span>
            </button>
        </div>
    </div>
	</div>


    <div class="main-content">
        <div class="editor-container">
            <div class="editor-wrapper">
                <textarea class="editor" id="editor" placeholder="烏衣行：切換到英數鍵盤來輸入..."></textarea>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div><span id="lineCount">1</span>行  <span id="charCount">0</span>字 </div>
		<div id="ime-external-toolbar-container" class="ime-external-toolbar"></div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <button class="toolbar-btn" onclick="toggleFullscreen()" title="全螢幕" style="width: 24px; height: 24px; font-size: 16px;"><span class="material-icons">fullscreen</span></button>
        </div>
    </div>
	

    <!-- 尋找與取代面板 -->
    <div class="find-panel" id="findPanel" style="display: none;">
        <div class="find-panel-header">
            <span class="material-icons drag-handle">drag_indicator</span>
            <span class="match-count" id="matchCount" style="font-size: 13px; color: #666; margin-left: 8px;"></span>
            <button class="close-btn" onclick="closeFindModal()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="find-panel-content">
            <div class="find-row">
                <label>尋找</label>
                <input type="text" id="findText" placeholder="輸入搜尋文字">
                <button class="find-btn" onclick="findPrevious()" title="上一個">
                    <span class="material-icons">keyboard_arrow_up</span>
                </button>
                <button class="find-btn" onclick="findNext()" title="下一個">
                    <span class="material-icons">keyboard_arrow_down</span>
                </button>
            </div>
            <div class="find-row">
                <label>取代</label>
                <input type="text" id="replaceText" placeholder="輸入取代文字">
                <button class="find-btn" onclick="replaceCurrent()" title="取代">
                    <span class="material-icons">check</span>
                </button>
                <button class="find-btn" onclick="replaceAll()" title="全部取代">
                    <span class="material-icons">done_all</span>
                </button>
            </div>
            <div class="find-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="replaceInSelection">
                    <span>選取範圍</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="useRegex">
                    <span>正則</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="matchCase">
                    <span>大小寫</span>
                </label>
            </div>
        </div>
    </div>

    <div class="modal" id="wordCountModal">
        <div class="modal-content">
            <div class="modal-header">文件統計</div>
            <div style="line-height: 1.8;">
                <div>字元數（含空格）: <span id="totalChars">0</span></div>
                <div>字元數（不含空格）: <span id="charsNoSpace">0</span></div>
                <div>單字數: <span id="wordCount">0</span></div>
                <div>行數: <span id="totalLines">1</span></div>
                <div>段落數: <span id="paragraphCount">1</span></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="closeWordCountModal()">確定</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newDocumentModal">
        <div class="modal-content">
            <div class="modal-header">建立新文件</div>
            <div style="line-height: 1.6; margin-bottom: 16px;">
                <p>您確定要建立新文件嗎？</p>
                <p style="color: #666; font-size: 14px;">目前的文字內容將會清空。如果您已啟用自動儲存，內容會保存在本機儲存中。</p>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeNewDocumentModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmNewDocument()">確定</button>
            </div>
        </div>
    </div>

    <!-- 辭典側邊欄 -->
    <div class="dictionary-sidebar" id="dictionarySidebar">
        <div class="dictionary-header">
            <div class="dictionary-title">辭典查詢</div>
            <button class="dictionary-close" onclick="closeDictionarySidebar()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="dictionary-content">
            <div class="dictionary-search">
                <div class="search-input-group">
                    <input type="text" id="dictionarySearchInput" placeholder="輸入要查詢的詞彙..." onkeypress="if(event.key==='Enter') performDictionarySearch()">
                    <button class="search-btn" onclick="performDictionarySearch()">
                        <span class="material-icons">search</span>
                    </button>
                </div>
            </div>
            <div class="dictionary-results" id="dictionaryResults">
                <div class="dictionary-placeholder">
                    <span class="material-icons" style="font-size: 48px; color: #ccc;">book</span>
                    <p style="color: #666; margin-top: 16px;">請輸入詞彙進行查詢</p>
                </div>
            </div>
        </div>
    </div>


    <!-- 側邊欄 -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">烏衣行設定</div>
            <button class="sidebar-close" onclick="closeSidebar()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-section">
                <h3>檔案</h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn" onclick="newDocument(); closeSidebar();" style="justify-content: flex-start; padding: 12px 16px;">
                        <span class="material-icons" style="margin-right: 8px;">description</span>
                        開新檔案
                    </button>
                    <button class="btn" onclick="openFile(); closeSidebar();" style="justify-content: flex-start; padding: 12px 16px;">
                        <span class="material-icons" style="margin-right: 8px;">folder_open</span>
                        開啟舊檔
                    </button>
                    <button class="btn" onclick="saveFile(); closeSidebar();" style="justify-content: flex-start; padding: 12px 16px;">
                        <span class="material-icons" style="margin-right: 8px;">download</span>
                        下載檔案
                    </button>
                    <button class="btn" onclick="showWordCount(); closeSidebar();" style="justify-content: flex-start; padding: 12px 16px;">
                        <span class="material-icons" style="margin-right: 8px;">text_fields</span>
                        文件統計
                    </button>
					<!-- 
                    <button class="btn" onclick="showAbout(); closeSidebar();" style="justify-content: flex-start; padding: 12px 16px;">
                        <span class="material-icons" style="margin-right: 8px;">info</span>
                        說明
                    </button>
					-->
                </div>
            </div>
            <div class="sidebar-section">
                <h3>自動儲存</h3>
                <label class="checkbox-label">
                    <input type="checkbox" id="autoSaveEnabled" checked onchange="toggleAutoSaveFromSidebar()">
                    <span>啟用自動儲存到本機</span>
                </label>
            </div>


			<!-- 
            <div class="sidebar-section> 
                <h3>顯示選單</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-sixian" checked onchange="toggleMenuVisibility('sixian')">
                        <span>四縣</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-hailu" checked onchange="toggleMenuVisibility('hailu')">
                        <span>海陸</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-dabu" checked onchange="toggleMenuVisibility('dabu')">
                        <span>大埔</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-raoping" checked onchange="toggleMenuVisibility('raoping')">
                        <span>饒平</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-zhaoan" checked onchange="toggleMenuVisibility('zhaoan')">
                        <span>詔安</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-hele" checked onchange="toggleMenuVisibility('hele')">
                        <span>和樂</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-matsu" checked onchange="toggleMenuVisibility('matsu')">
                        <span>馬祖</span>
                    </label>
                </div>
            </div>
			-->

        </div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">選單設定</div>
            <div class="settings-section">
                <h3>自動儲存</h3>
                <label class="checkbox-label">
                    <input type="checkbox" id="autoSaveEnabled" checked onchange="toggleAutoSaveFromSidebar()">
                    <span>啟用自動儲存到本機</span>
                </label>
            </div>
            <div class="settings-section">
                <h3>顯示選單</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-home" checked>
                        <span>首頁</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-insert" checked>
                        <span>插入</span>
                    </label>

                    <label class="checkbox-label">
                        <input type="checkbox" id="show-sixian" checked>
                        <span>四縣</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-hailu" checked>
                        <span>海陸</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-dabu" checked>
                        <span>大埔</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-raoping" checked>
                        <span>饒平</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-zhaoan" checked>
                        <span>詔安</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-hele" checked>
                        <span>和樂</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="show-matsu" checked>
                        <span>馬祖</span>
                    </label>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeSettings()">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">確定</button>
            </div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        let currentZoom = 100;
        let undoStack = [];
        let redoStack = [];
        let currentContent = '';
        let autoSaveEnabled = true;
        let autoSaveInterval;
        let selectedRange = null;

        // LocalStorage 前綴
        const STORAGE_PREFIX = 'wuyixing_editor_';

        // 初始化
        editor.addEventListener('input', function() {
            updateStatus();
            saveToUndoStack();
            if (autoSaveEnabled) {
                autoSave();
            }
        });
        

        
        // 載入設定和內容
        loadSettings();
        loadAutoSavedContent();
        loadFontSettings();

        // 選單切換
        function switchTab(tab) {
            // 更新選單樣式
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // 顯示對應工具列
            document.querySelectorAll('.toolbar').forEach(toolbar => {
                toolbar.style.display = 'none';
            });
            
            let toolbarId = tab + 'Toolbar';
            const toolbar = document.getElementById(toolbarId);
            if (toolbar) {
                toolbar.style.display = 'flex';
            }
        }

        // 側邊欄功能
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        function toggleAutoSaveFromSidebar() {
            const autoSaveCheckbox = document.getElementById('autoSaveEnabled');
            if (autoSaveCheckbox) {
                autoSaveEnabled = autoSaveCheckbox.checked;
                localStorage.setItem(STORAGE_PREFIX + 'autoSaveEnabled', autoSaveEnabled);
                
                const autoSaveBtn = document.getElementById('autoSaveBtn');
                if (autoSaveEnabled) {
                    autoSaveBtn.classList.add('active');
                    autoSaveBtn.title = '自動儲存：已啟用';
                } else {
                    autoSaveBtn.classList.remove('active');
                    autoSaveBtn.title = '自動儲存：已停用';
                }
            }
        }

        function toggleMenuVisibility(menu) {
            const checkbox = document.getElementById(`show-${menu}`);
            const menuItem = document.getElementById(`menu-${menu}`);
            
            if (checkbox && menuItem) {
                const isVisible = checkbox.checked;
                localStorage.setItem(STORAGE_PREFIX + 'show_' + menu, isVisible);
                menuItem.style.display = isVisible ? 'block' : 'none';
                
                // 重新檢查選單寬度
                checkMenuOverflow();
            }
        }

        // 更多選單功能
        function checkMenuOverflow() {
            const menuItems = document.getElementById('menuItems');
            const moreBtn = document.getElementById('moreBtn');
            const moreDropdown = document.getElementById('moreDropdown');
            
            // 重置所有項目到主選單
            const hiddenItems = moreDropdown.querySelectorAll('.menu-item');
            hiddenItems.forEach(item => {
                menuItems.appendChild(item);
            });
            
            // 隱藏更多按鈕
            moreBtn.style.display = 'none';
            
            // 檢查是否溢出
            const containerWidth = menuItems.parentElement.offsetWidth - 100; // 預留更多按鈕空間
            let totalWidth = 0;
            const items = Array.from(menuItems.children);
            
            items.forEach((item, index) => {
                if (index === 0) return; // 跳過烏衣行標題
                
                totalWidth += item.offsetWidth + 8; // 加上間距
                
                if (totalWidth > containerWidth) {
                    // 移動到更多選單
                    moreDropdown.appendChild(item);
                    moreBtn.style.display = 'block';
                }
            });
        }

        function toggleMoreMenu() {
            const dropdown = document.getElementById('moreDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        // 監聽視窗大小變化
        window.addEventListener('resize', checkMenuOverflow);
        window.addEventListener('load', checkMenuOverflow);

        // 點擊外部關閉下拉選單
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-toggle').forEach(btn => {
                    btn.classList.remove('open');
                });
            }
        });

        // 文件操作
        function newDocument() {
            if (editor.value) {
                document.getElementById('newDocumentModal').style.display = 'block';
            } else {
                confirmNewDocument();
            }
        }

        function closeNewDocumentModal() {
            document.getElementById('newDocumentModal').style.display = 'none';
        }

		function confirmNewDocument() {
			editor.value = '';
			updateStatus();
			undoStack = [];
			redoStack = [];
			clearHighlights();
			closeNewDocumentModal();
		}

        function openFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editor.value = e.target.result;
                        updateStatus();
                        clearSearchHighlights();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // 自動儲存功能
        function autoSave() {
            if (autoSaveEnabled) {
                localStorage.setItem(STORAGE_PREFIX + 'content', editor.value);
                localStorage.setItem(STORAGE_PREFIX + 'timestamp', new Date().toISOString());
            }
        }

        function loadAutoSavedContent() {
            const savedContent = localStorage.getItem(STORAGE_PREFIX + 'content');
            if (savedContent && !editor.value) {
                editor.value = savedContent;
                updateStatus();
            }
        }

        function toggleAutoSave() {
            autoSaveEnabled = !autoSaveEnabled;
            const btn = document.getElementById('autoSaveBtn');
            if (autoSaveEnabled) {
                btn.classList.add('active');
                btn.title = '自動儲存：已啟用';
                autoSave();
            } else {
                btn.classList.remove('active');
                btn.title = '自動儲存：已停用';
            }
            localStorage.setItem(STORAGE_PREFIX + 'autoSaveEnabled', autoSaveEnabled);
        }

        // 載入和儲存設定
        function loadSettings() {
            // 載入自動儲存設定
            const savedAutoSave = localStorage.getItem(STORAGE_PREFIX + 'autoSaveEnabled');
            if (savedAutoSave !== null) {
                autoSaveEnabled = savedAutoSave === 'true';
            }
            
            const autoSaveBtn = document.getElementById('autoSaveBtn');
            const autoSaveCheckbox = document.getElementById('autoSaveEnabled');
            
            if (autoSaveEnabled) {
                autoSaveBtn.classList.add('active');
                autoSaveBtn.title = '自動儲存：已啟用';
                if (autoSaveCheckbox) autoSaveCheckbox.checked = true;
            } else {
                autoSaveBtn.classList.remove('active');
                autoSaveBtn.title = '自動儲存：已停用';
                if (autoSaveCheckbox) autoSaveCheckbox.checked = false;
            }

            // 載入選單顯示設定
            const menus = ['sixian', 'hailu', 'dabu', 'raoping', 'zhaoan', 'hele', 'matsu'];
            menus.forEach(menu => {
                const saved = localStorage.getItem(STORAGE_PREFIX + 'show_' + menu);
                const checkbox = document.getElementById(`show-${menu}`);
                const menuItem = document.getElementById(`menu-${menu}`);
                
                if (saved !== null) {
                    const isVisible = saved === 'true';
                    if (checkbox) checkbox.checked = isVisible;
                    if (menuItem) {
                        menuItem.style.display = isVisible ? 'block' : 'none';
                    }
                } else {
                    // 預設顯示所有選單
                    if (checkbox) checkbox.checked = true;
                    if (menuItem) {
                        menuItem.style.display = 'block';
                    }
                }
            });
        }

        function saveFile() {
            const content = editor.value;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '文件.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 復原/重做
        function saveToUndoStack() {
            if (editor.value !== currentContent) {
                undoStack.push(currentContent);
                if (undoStack.length > 50) undoStack.shift();
                redoStack = [];
                currentContent = editor.value;
            }
        }

        function undo() {
            if (undoStack.length > 0) {
                redoStack.push(editor.value);
                editor.value = undoStack.pop();
                currentContent = editor.value;
                updateStatus();
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                undoStack.push(editor.value);
                editor.value = redoStack.pop();
                currentContent = editor.value;
                updateStatus();
            }
        }

        function insertAtCursor(text) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const value = editor.value;
            editor.value = value.substring(0, start) + text + value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + text.length;
            editor.focus();
            updateStatus();
        }



        // 尋找與取代
        let currentMatches = [];
        let currentMatchIndex = -1;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        function findReplace() {
            // 保存當前選取範圍
            if (editor.selectionStart !== editor.selectionEnd) {
                selectedRange = {
                    start: editor.selectionStart,
                    end: editor.selectionEnd,
                    text: editor.value.substring(editor.selectionStart, editor.selectionEnd)
                };
                
                // 只有單行文字才自動填入搜尋框
                if (!selectedRange.text.includes('\n')) {
                    document.getElementById('findText').value = selectedRange.text;
                }
            }
            
            const panel = document.getElementById('findPanel');
            panel.style.display = 'block';
            document.getElementById('findText').focus();
        }

        function closeFindModal() {
            document.getElementById('findPanel').style.display = 'none';
            selectedRange = null;
        }



        function createRegexPattern(text, useRegex, matchCase) {
            if (useRegex) {
                try {
                    return new RegExp(text, matchCase ? 'g' : 'gi');
                } catch (e) {
                    return null;
                }
            } else {
                const escapedText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                return new RegExp(escapedText, matchCase ? 'g' : 'gi');
            }
        }

        function findMatches() {
            const findText = document.getElementById('findText').value;
            const useRegex = document.getElementById('useRegex').checked;
            const matchCase = document.getElementById('matchCase').checked;
            
            if (!findText) {
                clearHighlights();
                return;
            }

            const pattern = createRegexPattern(findText, useRegex, matchCase);
            if (!pattern) {
                document.getElementById('matchCount').textContent = '正則表達式錯誤';
                return;
            }

            const content = editor.value;
            currentMatches = [];
            let match;

            while ((match = pattern.exec(content)) !== null) {
                currentMatches.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0]
                });
                if (!pattern.global) break;
            }

            updateMatchCount();
            updateSearchOverlay();
        }

        function updateMatchCount() {
            const count = currentMatches.length;
            const current = currentMatchIndex >= 0 ? currentMatchIndex + 1 : 0;
            document.getElementById('matchCount').textContent = 
                count > 0 ? `${current}/${count}` : count === 0 ? '找不到符合項目' : '';
        }

        function highlightMatches() {
            // 將當前匹配項反白並滾動到可見範圍
            if (currentMatches.length > 0 && currentMatchIndex >= 0) {
                const match = currentMatches[currentMatchIndex];
                editor.setSelectionRange(match.start, match.end);
                editor.focus();
                
                // 滾動到可見範圍
                const textBeforeMatch = editor.value.substring(0, match.start);
                const lineNumber = textBeforeMatch.split('\n').length - 1;
                const lineHeight = 24; // 預設行高
                const scrollTop = lineNumber * lineHeight - editor.clientHeight / 2;
                editor.scrollTop = Math.max(0, scrollTop);
            }
        }

        function clearHighlights() {
            currentMatches = [];
            currentMatchIndex = -1;
            updateMatchCount();
        }

        function findNext() {
            if (currentMatches.length === 0) {
                findMatches();
            }
            if (currentMatches.length > 0) {
                currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
                highlightMatches();
                updateMatchCount();
            }
        }

        function findPrevious() {
            if (currentMatches.length === 0) {
                findMatches();
            }
            if (currentMatches.length > 0) {
                currentMatchIndex = currentMatchIndex <= 0 ? currentMatches.length - 1 : currentMatchIndex - 1;
                highlightMatches();
                updateMatchCount();
            }
        }

        function replaceCurrent() {
            if (currentMatchIndex >= 0 && currentMatches.length > 0) {
                const match = currentMatches[currentMatchIndex];
                const replaceText = document.getElementById('replaceText').value;
                const content = editor.value;
                const lengthDiff = replaceText.length - (match.end - match.start);
                
                // 執行取代
                editor.value = content.substring(0, match.start) + replaceText + content.substring(match.end);
                
                updateStatus();
                
                // 重新搜尋並更新匹配項
                setTimeout(() => {
                    const oldMatchIndex = currentMatchIndex;
                    findMatches();
                    
                    if (currentMatches.length > 0) {
                        // 調整後續匹配項的位置
                        for (let i = 0; i < currentMatches.length; i++) {
                            if (currentMatches[i].start > match.start) {
                                currentMatches[i].start += lengthDiff;
                                currentMatches[i].end += lengthDiff;
                            }
                        }
                        
                        // 找到下一個要反白的匹配項
                        let nextIndex = -1;
                        for (let i = 0; i < currentMatches.length; i++) {
                            if (currentMatches[i].start >= match.start + replaceText.length) {
                                nextIndex = i;
                                break;
                            }
                        }
                        
                        // 如果沒找到後面的匹配項，從頭開始
                        if (nextIndex === -1 && currentMatches.length > 0) {
                            nextIndex = 0;
                        }
                        
                        if (nextIndex >= 0) {
                            currentMatchIndex = nextIndex;
                            highlightMatches();
                            updateMatchCount();
                        }
                    } else {
                        // 沒有更多匹配項
                        currentMatchIndex = -1;
                        updateMatchCount();
                    }
                }, 10);
            }
        }

        function replaceAll() {
            const findText = document.getElementById('findText').value;
            const replaceText = document.getElementById('replaceText').value;
            const useRegex = document.getElementById('useRegex').checked;
            const matchCase = document.getElementById('matchCase').checked;
            const replaceInSelection = document.getElementById('replaceInSelection').checked;
            
            if (!findText) return;
            
            const pattern = createRegexPattern(findText, useRegex, matchCase);
            if (!pattern) return;

            let content = editor.value;
            let newContent;
            
            if (replaceInSelection && selectedRange) {
                // 只在選取範圍內取代
                const selectionStart = selectedRange.start;
                const selectionEnd = selectedRange.end;
                const selectedText = content.substring(selectionStart, selectionEnd);
                const replacedSelection = selectedText.replace(pattern, replaceText);
                
                newContent = content.substring(0, selectionStart) + replacedSelection + content.substring(selectionEnd);
                editor.value = newContent;
                editor.setSelectionRange(selectionStart, selectionStart + replacedSelection.length);
            } else {
                // 全文取代
                newContent = content.replace(pattern, replaceText);
                editor.value = newContent;
            }
            
            updateStatus();
            findMatches();
        }

// 拖拽功能
        function initDragFunctionality() {
            const panel = document.getElementById('findPanel');
            const header = panel.querySelector('.find-panel-header');

            const dragStart = function(e) {
                // 如果點擊的是關閉按鈕，則不觸發拖曳
                if (e.target.closest('.close-btn')) return;
                // 只處理滑鼠左鍵
                if (e.type === 'mousedown' && e.button !== 0) return;

                isDragging = true;
                const rect = panel.getBoundingClientRect();
                
                // [修正] 兼容滑鼠與觸控事件的座標
                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

                dragOffset.x = clientX - rect.left;
                dragOffset.y = clientY - rect.top;
                
                // [修正] 註冊事件監聽，並為 touchmove 加上 { passive: false }
                // 這是告訴瀏覽器我們可能會阻止預設的滾動行為，非常關鍵
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('touchmove', handleDrag, { passive: false });
                
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchend', stopDrag);

                // [新增] 在觸控開始時就阻止預設行為 (如頁面滾動或文字選取)
                if (e.cancelable) {
                    e.preventDefault();
                }
            };

            header.addEventListener('mousedown', dragStart);
            header.addEventListener('touchstart', dragStart);
        }

        function handleDrag(e) {
            if (!isDragging) return;
            
            // [新增] 在觸控移動過程中，持續阻止頁面滾動
            if (e.type === 'touchmove' && e.cancelable) {
                e.preventDefault();
            }
            
            // [修正] 兼容滑鼠與觸控事件的座標
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

            const newX = clientX - dragOffset.x;
            const newY = clientY - dragOffset.y;
            
            const panel = document.getElementById('findPanel');
            panel.style.top = Math.max(0, Math.min(newY, window.innerHeight - panel.offsetHeight)) + 'px';
            panel.style.left = Math.max(0, Math.min(newX, window.innerWidth - panel.offsetWidth)) + 'px';
            
            // [最關鍵的修正]
            // 當我們開始用 'left' 來定位時，必須清除 'right' 的定位，
            // 否則 CSS 規則會衝突，導致面板不動。
            panel.style.right = 'auto';
        }

        function stopDrag() {
            isDragging = false;
            // [修正] 確保所有移動和結束事件的監聽器都被移除
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('touchmove', handleDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        // 監聽輸入變化
        document.getElementById('findText').addEventListener('input', findMatches);
        document.getElementById('useRegex').addEventListener('change', findMatches);
        document.getElementById('matchCase').addEventListener('change', findMatches);

        // 檢視功能
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function zoomIn() {
            currentZoom += 10;
            updateZoom();
        }

        function zoomOut() {
            if (currentZoom > 50) {
                currentZoom -= 10;
                updateZoom();
            }
        }

        function updateZoom() {
            document.body.style.zoom = currentZoom + '%';
            document.getElementById('zoomLevel').textContent = currentZoom + '%';
        }

        // 複製、剪下、貼上、全選功能
        function copyText() {
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (selectedText) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    // 可以添加提示訊息
                }).catch(() => {
                    // 備用方法
                    editor.select();
                    document.execCommand('copy');
                });
            } else {
                alert('請先選取要複製的文字');
            }
        }

        function cutText() {
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (selectedText) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start;
                    updateStatus();
                }).catch(() => {
                    // 備用方法
                    document.execCommand('cut');
                    updateStatus();
                });
            } else {
                alert('請先選取要剪下的文字');
            }
        }

        function pasteText() {
            navigator.clipboard.readText().then(text => {
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                editor.value = editor.value.substring(0, start) + text + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + text.length;
                updateStatus();
            }).catch(() => {
                // 備用方法 - 提示用戶使用 Ctrl+V
                alert('請使用 Ctrl+V 來貼上文字');
            });
        }

        function selectAll() {
            editor.select();
            editor.focus();
        }

        // 字數統計
        function showWordCount() {
            const content = editor.value;
            // 使用 Array.from 正確計算包含 Unicode 字符的字數
            const totalChars = Array.from(content).length;
            const charsNoSpace = Array.from(content.replace(/\s/g, '')).length;
            const words = content.trim() ? content.trim().split(/\s+/).length : 0;
            const lines = content.split('\n').length;
            const paragraphs = content.trim() ? content.split(/\n\s*\n/).length : 0;

            document.getElementById('totalChars').textContent = totalChars;
            document.getElementById('charsNoSpace').textContent = charsNoSpace;
            document.getElementById('wordCount').textContent = words;
            document.getElementById('totalLines').textContent = lines;
            document.getElementById('paragraphCount').textContent = paragraphs;
            
            document.getElementById('wordCountModal').style.display = 'block';
        }

        function closeWordCountModal() {
            document.getElementById('wordCountModal').style.display = 'none';
        }

        // 狀態更新
        function updateStatus() {
            const content = editor.value;
            // 使用 Array.from 正確計算包含 Unicode 字符的字數（不含空白）
            const charsNoSpace = Array.from(content.replace(/\s/g, '')).length;
            document.getElementById('charCount').textContent = charsNoSpace;
            document.getElementById('lineCount').textContent = content.split('\n').length;
        }

        // 客語翻譯功能
        function translateToHakka(dialect) {
            const selectedText = getSelectedText();
            if (!selectedText) {
                alert('請先選取要翻譯的文字');
                return;
            }
            
            // 這裡是示範功能，實際應用需要連接真實的翻譯API
            const translatedText = `[${dialect}客語翻譯] ${selectedText}`;
            replaceSelectedText(translatedText);
        }

        function translateToTaiwanese(dialect) {
            const selectedText = getSelectedText();
            if (!selectedText) {
                alert('請先選取要翻譯的文字');
                return;
            }
            
            const translatedText = `[台語翻譯] ${selectedText}`;
            replaceSelectedText(translatedText);
        }

        function translateToFuzhou(dialect) {
            const selectedText = getSelectedText();
            if (!selectedText) {
                alert('請先選取要翻譯的文字');
                return;
            }
            
            const translatedText = `[福州話翻譯] ${selectedText}`;
            replaceSelectedText(translatedText);
        }

        function translateToMandarin(dialect) {
            const selectedText = getSelectedText();
            if (!selectedText) {
                alert('請先選取要翻譯的文字');
                return;
            }
            
            const translatedText = `[華語翻譯] ${selectedText}`;
            replaceSelectedText(translatedText);
        }

        function toPinyin(dialect) {
            const selectedText = getSelectedText();
            if (!selectedText) {
                alert('請先選取要轉換拼音的文字');
                return;
            }
            
            const pinyinText = `[${dialect}拼音] ${selectedText}`;
            replaceSelectedText(pinyinText);
        }

        function convertPinyin(dialect) {
            const selectedText = getSelectedText();
            if (!selectedText) {
                alert('請先選取要轉換的拼音');
                return;
            }
            
            const convertedText = `[拼音轉換] ${selectedText}`;
            replaceSelectedText(convertedText);
        }

        function togglePinyinDropdown(dialect) {
            const dropdown = document.getElementById(`pinyinDropdown-${dialect}`);
            const toggle = event.target.closest('.dropdown-toggle');
            
            // 關閉其他下拉選單
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu !== dropdown) {
                    menu.classList.remove('show');
                }
            });
            document.querySelectorAll('.dropdown-toggle').forEach(btn => {
                if (btn !== toggle) {
                    btn.classList.remove('open');
                }
            });
            
            // 切換當前下拉選單
            if (dropdown) {
                dropdown.classList.toggle('show');
                toggle.classList.toggle('open');
            }
        }

        function convertPinyin(dialect, type) {
            const selectedText = getSelectedText();
            if (!selectedText) {
                alert('請先選取要轉換拼音的文字');
                return;
            }
            
            let convertedText;
            switch(type) {
                case 'number-to-tone':
                    convertedText = `[${dialect}] ${selectedText} → 數字調轉字尾調示範`;
                    break;
                case 'tone-to-number':
                    convertedText = `[${dialect}] ${selectedText} → 字尾調轉數字調示範`;
                    break;
                case 'letter-to-tone':
                    convertedText = `[${dialect}] ${selectedText} → 字母調轉字尾調示範`;
                    break;
                case 'tone-to-letter':
                    convertedText = `[${dialect}] ${selectedText} → 字尾調轉字母調示範`;
                    break;
                default:
                    convertedText = `[${dialect}拼音] ${selectedText}`;
            }
            
            replaceSelectedText(convertedText);
            
            // 關閉下拉選單
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            document.querySelectorAll('.dropdown-toggle').forEach(btn => {
                btn.classList.remove('open');
            });
        }

        function searchDictionary(dialect) {
            const selectedText = getSelectedText();
            
            // 直接開啟辭典側邊欄
            openDictionarySidebar(dialect, selectedText);
        }

        function openDictionarySidebar(dialect, searchTerm) {
            const sidebar = document.getElementById('dictionarySidebar');
            const searchInput = document.getElementById('dictionarySearchInput');
            
            sidebar.classList.add('open');
            
            if (searchTerm) {
                searchInput.value = searchTerm;
                performDictionarySearch(dialect);
            }
        }

        function closeDictionarySidebar() {
            const sidebar = document.getElementById('dictionarySidebar');
            
            sidebar.classList.remove('open');
        }

        function performDictionarySearch(dialect) {
            const searchTerm = document.getElementById('dictionarySearchInput').value.trim();
            const resultsContainer = document.getElementById('dictionaryResults');
            
            if (!searchTerm) {
                resultsContainer.innerHTML = `
                    <div class="dictionary-placeholder">
                        <span class="material-icons" style="font-size: 48px; color: #ccc;">book</span>
                        <p style="color: #666; margin-top: 16px;">請輸入詞彙進行查詢</p>
                    </div>
                `;
                return;
            }
            
            // 模擬辭典查詢結果
            const sampleResults = generateSampleDictionaryResults(searchTerm, dialect || 'general');
            
            resultsContainer.innerHTML = sampleResults.length > 0 ? 
                sampleResults.map(result => `
                    <div class="dictionary-entry">
                        <div class="dictionary-word">${result.word}</div>
                        <div class="dictionary-pronunciation">${result.pronunciation}</div>
                        <div class="dictionary-definition">${result.definition}</div>
                        ${result.example ? `<div class="dictionary-example">${result.example}</div>` : ''}
                    </div>
                `).join('') :
                `<div class="dictionary-placeholder">
                    <span class="material-icons" style="font-size: 48px; color: #ccc;">search_off</span>
                    <p style="color: #666; margin-top: 16px;">找不到「${searchTerm}」的相關結果</p>
                </div>`;
        }

        function generateSampleDictionaryResults(searchTerm, dialect) {
            // 這裡是示範資料，實際應用需要連接真實的辭典API
            const sampleData = {
                '你好': [
                    {
                        word: '你好',
                        pronunciation: 'nˇ hoˋ',
                        definition: '招呼語，用於見面時的問候。',
                        example: '佢同我講「你好」。'
                    }
                ],
                '食飯': [
                    {
                        word: '食飯',
                        pronunciation: 'sii̍t pn̄g',
                        definition: '吃飯，進食米飯或泛指用餐。',
                        example: '時間到了，愛食飯了。'
                    }
                ],
                '屋下': [
                    {
                        word: '屋下',
                        pronunciation: 'vuk haˊ',
                        definition: '家裡，住所。',
                        example: '我轉屋下去了。'
                    }
                ]
            };
            
            return sampleData[searchTerm] || [
                {
                    word: searchTerm,
                    pronunciation: `[${dialect || '示範'}拼音]`,
                    definition: `「${searchTerm}」的詞義解釋（示範資料）`,
                    example: `例句：${searchTerm}的使用範例。`
                }
            ];
        }

        function inputMethod(dialect) {
            alert(`正在啟動${dialect}輸入法...`);
        }

        function getSelectedText() {
            return editor.value.substring(editor.selectionStart, editor.selectionEnd);
        }

        function replaceSelectedText(newText) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const content = editor.value;
            
            editor.value = content.substring(0, start) + newText + content.substring(end);
            editor.setSelectionRange(start, start + newText.length);
            updateStatus();
        }

        // 設定功能
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function showAbout() {
            alert('烏衣行文字編輯器\n版本：1.0\n支援多種客語方言及台語、福州話的文字處理工具');
        }

        function saveSettings() {
            // 儲存自動儲存設定
            const autoSaveCheckbox = document.getElementById('autoSaveEnabled');
            if (autoSaveCheckbox) {
                autoSaveEnabled = autoSaveCheckbox.checked;
                localStorage.setItem(STORAGE_PREFIX + 'autoSaveEnabled', autoSaveEnabled);
                
                const autoSaveBtn = document.getElementById('autoSaveBtn');
                if (autoSaveEnabled) {
                    autoSaveBtn.classList.add('active');
                    autoSaveBtn.title = '自動儲存：已啟用';
                } else {
                    autoSaveBtn.classList.remove('active');
                    autoSaveBtn.title = '自動儲存：已停用';
                }
            }

            // 儲存選單顯示設定
            const menus = ['home', 'insert', 'view', 'settings', 'sixian', 'hailu', 'dabu', 'raoping', 'zhaoan', 'hele', 'matsu'];
            
            menus.forEach(menu => {
                const checkbox = document.getElementById(`show-${menu}`);
                const menuItem = document.getElementById(`menu-${menu}`) || document.querySelector(`.menu-item[onclick="switchTab('${menu}')"]`);
                
                if (checkbox && menuItem) {
                    const isVisible = checkbox.checked;
                    localStorage.setItem(STORAGE_PREFIX + 'show_' + menu, isVisible);
                    menuItem.style.display = isVisible ? 'block' : 'none';
                }
            });
            
            closeSettings();
        }

        // 初始化狀態
        updateStatus();
        saveToUndoStack();
        initDragFunctionality();

        // 字體和字型大小變更功能
        function changeFontFamily() {
            const fontFamily = document.getElementById('fontFamily').value;
            editor.style.fontFamily = fontFamily;
            localStorage.setItem(STORAGE_PREFIX + 'fontFamily', fontFamily);
        }

        function changeFontSize() {
            const fontSize = document.getElementById('fontSize').value;
            editor.style.fontSize = fontSize + 'px';
            localStorage.setItem(STORAGE_PREFIX + 'fontSize', fontSize);
        }

        // 載入字體設定
        function loadFontSettings() {
            const savedFontFamily = localStorage.getItem(STORAGE_PREFIX + 'fontFamily');
            const savedFontSize = localStorage.getItem(STORAGE_PREFIX + 'fontSize');
            
            if (savedFontFamily) {
                document.getElementById('fontFamily').value = savedFontFamily;
                editor.style.fontFamily = savedFontFamily;
            }
            
            if (savedFontSize) {
                document.getElementById('fontSize').value = savedFontSize;
                editor.style.fontSize = savedFontSize + 'px';
            }
        }
    </script>
    <script src="ime-dict.js"></script>
    <script src="ime.js"></script>
    <script src="ime-button.js"></script>
</html>
