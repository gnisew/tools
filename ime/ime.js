const defaultKeyMap={selectCandidate:[' '],commitComposition:['Enter'],clearComposition:["'",'Escape'],nextCandidate:['.','ArrowRight'],prevCandidate:[',','ArrowLeft'],nextPage:[']','PageDown','ArrowDown'],prevPage:['[','PageUp','ArrowUp'],moveCursorRight:['>'],moveCursorLeft:['<'],toggleLongPhrase:['='],transformTone:['w'],backspaceWithCandidates:[";"],reverseLookup:['/']};const hakkaPunctuationMappings={'x':'， 。 、 ？ ！ ； ： 「」 （） 『』 ── …… ﹏﹏ 〈〉 《》 ＿＿ ． — ～','xx':'； ： 「」 （） 『』 ── …… ﹏﹏ 〈〉 《》 ＿＿ ． — ～','xxx':'── …… ﹏﹏ 〈〉 《》 ＿＿ ． — ～','xxxx':'＿＿ ． — ～','xd':'、 ．','xj':'。 ．','xw':'？','xt':'！','xf':'；','xm':'：','xy':'「 」 『 』','xyy':'」 』','xg':'（　） 〈 〉 《 》','xgg':'） 〉 》','xp':'──','xs':'…… ﹏﹏ 〈 〉 《 》','xl':'— ～',};const targetLanguages=['kasu','sixian','hailu','dapu','raoping','sixiannan','holo','matsu','cangjie','xiami'];targetLanguages.forEach(lang=>{if(dictionaries[lang]){Object.assign(dictionaries[lang],hakkaPunctuationMappings)}});const imeLanguageProperties={'cangjie':{maxLength:5,longPhraseMode:false,allowLongPhraseToggle:false,enableToneTransform:false,spaceActionOnNoCandidates:'clear',layoutType:'narrow',toneType:'alphabetic',keyMap:{...defaultKeyMap,selectCandidate:[' '],nextCandidate:['.','ArrowRight','>'],prevCandidate:[',','ArrowLeft','<'],nextPage:['PageDown','ArrowDown',']'],prevPage:['PageUp','ArrowUp','['],moveCursorRight:[],moveCursorLeft:[],toggleLongPhrase:[],transformTone:[]}},'xiami':{maxLength:5,longPhraseMode:false,allowLongPhraseToggle:false,enableToneTransform:false,spaceActionOnNoCandidates:'clear',layoutType:'narrow',toneType:'alphabetic',keyMap:{...defaultKeyMap,selectCandidate:[' '],nextCandidate:['.','ArrowRight','>'],prevCandidate:[',','ArrowLeft','<'],nextPage:['PageDown','ArrowDown',']'],prevPage:['PageUp','ArrowUp','['],moveCursorRight:[],moveCursorLeft:[],toggleLongPhrase:[],transformTone:[]}},'hanglie':{maxLength:5,longPhraseMode:false,allowLongPhraseToggle:false,enableToneTransform:false,spaceActionOnNoCandidates:'clear',layoutType:'narrow',toneType:'alphabetic',keyMap:{...defaultKeyMap,nextCandidate:['ArrowRight','>'],prevCandidate:['ArrowLeft','<'],nextPage:['PageDown','ArrowDown',']'],prevPage:['PageUp','ArrowUp','['],moveCursorRight:[],moveCursorLeft:[],reverseLookup:[],backspaceWithCandidates:[],transformTone:[]}},'pinyin':{toneType:'numeric',spaceActionOnNoCandidates:'clear',initialConsonants:['zh','ch','sh','b','p','m','f','d','t','n','l','g','k','h','j','q','x','r','z','c','s','y','w'],keyMap:defaultKeyMap},'kasu':{toneType:'alphabetic',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['zh','ch','sh','rh','ng','bb','b','p','m','f','v','d','t','n','l','g','k','h','z','c','s'],numericToneMap:{'1':'','2':'z','6':'z','3':'v','4':'s','7':'x','5':'x'}},'sixian':{toneType:'numeric',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['ng','b','p','m','f','v','d','t','n','l','g','k','h','j','q','x','z','c','s'],numericToneMap:{'1':'','2':'z','6':'z','3':'v','4':'s'}},'hailu':{toneType:'numeric',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['zh','ch','sh','rh','ng','b','p','m','f','v','d','t','n','l','g','k','h','z','c','s'],numericToneMap:{'1':'','2':'z','6':'z','3':'v','7':'f','4':'s'}},'dapu':{toneType:'numeric',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['zh','ch','sh','rh','ng','b','p','m','f','v','d','t','n','l','g','k','h','z','c','s'],numericToneMap:{'1':'','2':'z','6':'z','3':'v','7':'f','5':'x','4':'s'}},'raoping':{toneType:'numeric',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['zh','ch','sh','rh','ng','b','p','m','f','v','d','t','n','l','g','k','h','z','c','s'],numericToneMap:{'1':'','2':'z','6':'z','3':'v','7':'f','5':'x','4':'s'}},'sixiannan':{toneType:'numeric',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['ng','b','p','m','f','v','d','t','n','l','g','k','h','j','q','x','z','c','s'],numericToneMap:{'1':'','2':'z','6':'z','3':'v','4':'s'}},'holo':{toneType:'numeric',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['tsh','kh','ng','ph','th','ts','b','g','h','j','k','l','m','n','p','s','t'],numericToneMap:{'1':'','2':'z','3':'s','4':'','5':'x','7':'f','8':'l'}},'matsu':{toneType:'numeric',toneModes:['alphabetic','numeric'],keyMap:defaultKeyMap,spaceActionOnNoCandidates:'clear',initialConsonants:['tsh','kh','ng','ph','th','ts','b','g','h','j','k','l','m','n','p','s','t','y'],numericToneMap:{'1':'','2':'f','3':'v','4':'z','5':'s','7':'x','8':''}},};const imeToneMappings={'pinyin':/[1-5]/,'kasu':/[zvsfxl]$/,'sixian':/[zvs]$/,'hailu':/[zvsf]$/,'dapu':/[zvsxf]$/,'raoping':/[zvsxf]$/,'sixiannan':/[zvs]$/,'holo':/[zvsfxl]$/,'matsu':/[zvsfx]$/,};(function(){(function forceLoadMaterialIcons(){const styleId='google-material-icons-stylesheet';if(document.getElementById(styleId)||document.querySelector('link[href*="Material+Icons"]')){return}const link=document.createElement('link');link.id=styleId;link.rel='stylesheet';link.href='https://fonts.googleapis.com/icon?family=Material+Icons';document.head.insertBefore(link,document.head.firstChild)})();const materialIcons=['emoji_people','accessibility','accessibility_new','directions_run','directions_walk','downhill_skiing','sports_martial_arts','self_improvement','skateboarding','sledding','snowboarding','sports_handball','surfing'];const randomIconName=materialIcons[Math.floor(Math.random()*materialIcons.length)];if(window.WebIME){return}const WebIME={isInitialized:false,boundGlobalKeyDownHandler:null,boundEnsureInBounds:null,isPredictionState:false,predictionMap:{},defaultKeyMap:window.defaultKeyMap||{},activeElement:null,boundFocusInHandler:null,boundFocusOutHandler:null,toolbarContainer:null,candidatesContainer:null,candidatesList:null,topBar:null,toastElement:null,allToneModeButtons:[],allLongPhraseButtons:[],allPunctuationButtons:[],allOutputModeButtons:[],allSettingsButtons:[],allModeDisplayTexts:[],allModeMenus:[],allEnableToggles:[],externalToolbarContainer:null,modeDisplayButton:null,modeDisplayText:null,modeMenu:null,compositionDisplay:null,longPhraseToggleBtn:null,prevPageBtn:null,nextPageBtn:null,toneModeToggleBtn:null,outputModeToggleBtn:null,config:{defaultMode:'sixian',longPhrase:false,candidatesPerPage:5,maxCompositionLength:30,storagePrefix:'webime_1_',enablePrediction:false,outputMode:'pinyin',},isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isCommittingText:false,lastInputValue:'',isEnabled:true,isLongPhraseEnabled:true,currentMode:'pinyin',toneModes:{},compositionBuffer:'',compositionCursorPos:0,allCandidates:[],currentPage:0,highlightedIndex:0,phraseCache:{},boundHandleInput:null,boundHandleKeyDown:null,boundInitDrag:null,boundDragMove:null,boundDragEnd:null,isDragging:false,isClickingInside:false,isPinned:false,pinnedTop:'50px',pinnedLeft:'50px',pinToggleBtn:null,boundReposition:null,offsetX:0,offsetY:0,preprocessedDicts:{},isFullWidthMode:true,punctuationModeToggleBtn:null,isQueryMode:false,isPositionRight:false,queriedWord:'',originalState:null,reverseDicts:{cangjie:{},xiami:{}},preprocessDictionaries(){console.log("Preprocessing dictionaries for performance optimization...");for(const mode in dictionaries){if(Object.hasOwnProperty.call(dictionaries,mode)){this.preprocessedDicts[mode]={};const dictionary=dictionaries[mode];for(const key in dictionary){if(Object.hasOwnProperty.call(dictionary,key)){const simplifiedKey=this.simplifyKey(key,mode);if(simplifiedKey.length===0)continue;const firstChar=simplifiedKey[0].toLowerCase();if(!this.preprocessedDicts[mode][firstChar]){this.preprocessedDicts[mode][firstChar]=[]}this.preprocessedDicts[mode][firstChar].push({originalKey:key,simplifiedKey:simplifiedKey,values:dictionary[key].split(' ')})}}}}console.log("Preprocessing complete.")},createReverseDictionaries(){console.log("Creating reverse dictionaries for query and pinyin output features...");const modesToProcess=Object.keys(dictionaries);modesToProcess.forEach(mode=>{const dictionary=dictionaries[mode];if(!dictionary)return;if(!this.reverseDicts[mode]){this.reverseDicts[mode]={}}for(const code in dictionary){if(Object.hasOwnProperty.call(dictionary,code)){const words=dictionary[code].split(' ');words.forEach(word=>{if(!this.reverseDicts[mode][word]){this.reverseDicts[mode][word]=[]}if(!this.reverseDicts[mode][word].includes(code)){this.reverseDicts[mode][word].push(code)}})}}});console.log("Reverse dictionaries created.")},createPredictionMap(){console.log("Creating prediction maps...");for(const mode in dictionaries){this.predictionMap[mode]={};const dictionary=dictionaries[mode];for(const key in dictionary){const words=dictionary[key].split(' ');for(const word of words){if(word.length>1){for(let i=1;i<word.length;i++){const prefix=word.substring(0,i);const suffix=word.substring(i);if(!this.predictionMap[mode][prefix]){this.predictionMap[mode][prefix]=new Set()}this.predictionMap[mode][prefix].add(suffix)}}}}for(const prefix in this.predictionMap[mode]){this.predictionMap[mode][prefix]=Array.from(this.predictionMap[mode][prefix])}}console.log("Prediction maps created.")},findPredictionCandidates(prefix){if(!prefix){return[]}const predictionMode=(this.config.predictionMapping&&this.config.predictionMapping[this.currentMode])?this.config.predictionMapping[this.currentMode]:this.currentMode;if(!predictionMode||!this.predictionMap[predictionMode]){return[]}return this.predictionMap[predictionMode][prefix]||[]},loadPredictionSettings(){const saved=localStorage.getItem(this.config.storagePrefix+'prediction');this.config.enablePrediction=(saved!==null)?(saved==='true'):false;if(this.settingsModal){const checkbox=this.settingsModal.querySelector('#toggle-prediction');if(checkbox){checkbox.checked=this.config.enablePrediction}}},savePredictionSettings(){const checkbox=this.settingsModal.querySelector('#toggle-prediction');if(checkbox){this.config.enablePrediction=checkbox.checked;localStorage.setItem(this.config.storagePrefix+'prediction',this.config.enablePrediction)}},loadPredictionMappingSettings(){let settings;try{settings=JSON.parse(localStorage.getItem(this.config.storagePrefix+'predictionMapping'))}catch(e){settings=null}this.config.predictionMapping=settings||{}},savePredictionMappingSettings(){if(!this.settingsModal)return;const newMapping={};const selectElements=this.settingsModal.querySelectorAll('.prediction-source-select');selectElements.forEach(select=>{const imeMode=select.dataset.ime;if(imeMode&&select.value){newMapping[imeMode]=select.value}});this.config.predictionMapping=newMapping;localStorage.setItem(this.config.storagePrefix+'predictionMapping',JSON.stringify(newMapping));this.showToast('聯想詞來源已儲存')},init(userConfig={}){this.isEnabled=true;if(this.isInitialized){console.warn("WebIME is already initialized.");return}this.preprocessDictionaries();this.createReverseDictionaries();this.createPredictionMap();this.config={...this.config,...userConfig};this.config.globalMaxCompositionLength=this.config.maxCompositionLength;const savedMode=localStorage.getItem(this.config.storagePrefix+'mode');const urlMode=(userConfig.defaultMode&&dictionaries[userConfig.defaultMode])?userConfig.defaultMode:null;this.currentMode=(savedMode&&dictionaries[savedMode])?savedMode:(urlMode||this.config.defaultMode);const savedLongPhrase=localStorage.getItem(this.config.storagePrefix+'longPhrase');if(typeof userConfig.longPhrase==='boolean'){this.isLongPhraseEnabled=userConfig.longPhrase}else{this.isLongPhraseEnabled=(savedLongPhrase!==null)?(savedLongPhrase==='true'):this.config.longPhrase}const savedToneModes=localStorage.getItem(this.config.storagePrefix+'toneModes');if(savedToneModes){try{this.toneModes=JSON.parse(savedToneModes)}catch(e){this.toneModes={}}}if(userConfig.initialToneMode){this.toneModes[this.currentMode]=userConfig.initialToneMode}const savedFullWidth=localStorage.getItem(this.config.storagePrefix+'fullWidth');if(typeof userConfig.initialFullWidth==='boolean'){this.isFullWidthMode=userConfig.initialFullWidth}else{this.isFullWidthMode=(savedFullWidth!==null)?(savedFullWidth==='true'):true}const savedPrediction=localStorage.getItem(this.config.storagePrefix+'prediction');if(typeof userConfig.enablePrediction==='boolean'){this.config.enablePrediction=userConfig.enablePrediction}else{this.config.enablePrediction=(savedPrediction!==null)?(savedPrediction==='true'):false}const savedOutputMode=localStorage.getItem(this.config.storagePrefix+'outputMode');if(userConfig.outputMode){this.config.outputMode=userConfig.outputMode}else{this.config.outputMode=['word','pinyin','word_pinyin','word_pinyin2'].includes(savedOutputMode)?savedOutputMode:'word'}this.boundReposition=this.imeReposition.bind(this);this.boundHandleInput=this.imeHandleInput.bind(this);this.boundHandleKeyDown=this.imeHandleKeyDown.bind(this);this.boundInitDrag=this.imeInitDrag.bind(this);this.boundDragMove=this.imeDragMove.bind(this);this.boundDragEnd=this.imeDragEnd.bind(this);this.boundEnsureInBounds=this.ensureInBounds.bind(this);this.loadKeyMapSettings();this.loadToolbarSettings();const savedOutputModeActive=localStorage.getItem(this.config.storagePrefix+'outputModeActive');this.config.outputModeActive=savedOutputModeActive==='true';if(typeof userConfig.outputEnabled==='boolean'){this.config.toolbarButtons.outputModeToggle=userConfig.outputEnabled}this.loadOutputModeSettings();if(userConfig.outputMode){this.config.outputMode=userConfig.outputMode}this.loadPredictionSettings();if(typeof userConfig.enablePrediction==='boolean'){this.config.enablePrediction=userConfig.enablePrediction}this.loadPredictionMappingSettings();this.createUI();this.externalToolbarContainer=document.getElementById('ime-external-toolbar-container');if(this.externalToolbarContainer){this.createExternalToolbar()}this.loadQuerySettings();const pinnedTop=localStorage.getItem(this.config.storagePrefix+'pinnedTop');const pinnedLeft=localStorage.getItem(this.config.storagePrefix+'pinnedLeft');if(pinnedTop&&pinnedLeft){this.toolbarContainer.style.top=pinnedTop;this.toolbarContainer.style.left=pinnedLeft;this.toolbarContainer.style.bottom='auto';this.toolbarContainer.style.right='auto'}else{this.toolbarContainer.style.left='10px';this.toolbarContainer.style.right='auto'}this.updateToolbarButtonsVisibility();this.updateToneModeButtonUI();this.updateOutputModeButtonUI();const initialLangProps=imeLanguageProperties[this.currentMode]||{};this.config.maxCompositionLength=initialLangProps.maxLength||this.config.globalMaxCompositionLength;if(initialLangProps.allowLongPhraseToggle===false){this.isLongPhraseEnabled=initialLangProps.longPhraseMode===true}this.longPhraseToggleBtn.classList.toggle('active',this.isLongPhraseEnabled);if(initialLangProps.layoutType==='narrow'){this.candidatesContainer.classList.add('ime-narrow')}else{this.candidatesContainer.classList.remove('ime-narrow')}this.updatePunctuationButtonUI();this.attachEventListeners();window.addEventListener('resize',this.boundEnsureInBounds);this.boundGlobalKeyDownHandler=(e)=>{if(e.ctrlKey&&e.key==='/'){e.preventDefault();this.toggleIsEnabled()}else if(e.ctrlKey&&e.key==='\\'){e.preventDefault();this.toggleOutputMode()}};document.addEventListener('keydown',this.boundGlobalKeyDownHandler);document.addEventListener('keydown',this.boundGlobalKeyDownHandler);document.addEventListener('mousedown',(e)=>{if(!this.isInitialized||!this.candidatesContainer||this.candidatesContainer.style.display==='none'){return}const isClickInsideIME=this.toolbarContainer.contains(e.target)||this.candidatesContainer.contains(e.target);if(!isClickInsideIME){this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates()}});this.isInitialized=true;console.log("WebIME initialized.")},destroy(){if(!this.isInitialized){return}this.deactivate();if(this.boundFocusInHandler){document.removeEventListener("focusin",this.boundFocusInHandler)}if(this.boundFocusOutHandler){document.removeEventListener("focusout",this.boundFocusOutHandler)}if(this.boundGlobalKeyDownHandler){document.removeEventListener('keydown',this.boundGlobalKeyDownHandler)}if(this.boundEnsureInBounds){window.removeEventListener('resize',this.boundEnsureInBounds)}if(this.toolbarContainer){this.toolbarContainer.remove();this.toolbarContainer=null}if(this.candidatesContainer){this.candidatesContainer.remove();this.candidatesContainer=null}if(this.settingsModal){this.settingsModal.remove();this.settingsModal=null}this.compositionBuffer='';this.allCandidates=[];this.activeElement=null;this.allModeMenus=[];this.allModeDisplayTexts=[];this.isInitialized=false;console.log("WebIME has been destroyed.")},getInitial(word,mode){const langProps=imeLanguageProperties[mode]||{};const initials=langProps.initialConsonants;if(!initials){return word[0]||''}for(const initial of initials){if(word.startsWith(initial)){return initial}}return word[0]||''},simplifyKey(key,mode){const toneRegex=imeToneMappings[mode];if(!toneRegex){return key.replace(/[\s-]+/g,'')}const simplifiedParts=key.split(/[\s-]+/).map(part=>part.replace(toneRegex,''));return simplifiedParts.join('')},normalizeCompositionBuffer(buffer,mode){if(mode!=='kasu'){return buffer}let normalized=buffer;normalized=normalized.replace(/([bpfvdtlgkhzcsi])oo/g,'$1o');normalized=normalized.replace(/rh([aeiou])/g,'r$1');normalized=normalized.replace(/bb([aeiou])/g,'v$1');normalized=normalized.replace(/ji/g,'zi').replace(/qi/g,'ci').replace(/xi/g,'si');return normalized},createUI(){this.toolbarContainer=document.createElement("div");this.toolbarContainer.id="web-ime-toolbar-container";this.toolbarContainer.className="web-ime-base";this.toolbarContainer.style.position='fixed';this.toolbarContainer.style.top='10px';this.toolbarContainer.style.bottom='auto';this.topBar=document.createElement("div");this.topBar.id="web-ime-top-bar";this.topBar.addEventListener('mousedown',this.boundInitDrag);this.topBar.addEventListener('touchstart',this.boundInitDrag,{passive:false});const logo=document.createElement("span");logo.className="ime-logo material-icons";logo.textContent=randomIconName;this.topBar.appendChild(logo);const enableContainer=document.createElement('div');enableContainer.className='ime-enable-container';const enableToggle=document.createElement('input');enableToggle.type='checkbox';enableToggle.className='ime-enable-toggle';enableToggle.id='web-ime-enable-toggle-main';enableToggle.checked=this.isEnabled;enableToggle.addEventListener('change',(e)=>{this.setIsEnabled(e.target.checked);const status=this.isEnabled?"已啟用":"已停用";this.showToast(`輸入法${status}`)});this.allEnableToggles.push(enableToggle);const enableLabel=document.createElement('label');enableLabel.className='ime-enable-label';enableLabel.htmlFor='web-ime-enable-toggle-main';enableLabel.innerHTML='<span></span>';enableContainer.appendChild(enableToggle);enableContainer.appendChild(enableLabel);this.topBar.appendChild(enableContainer);const modeContainer=document.createElement("div");modeContainer.className="ime-mode-container";this.modeDisplayButton=document.createElement("button");this.modeDisplayButton.type="button";this.modeDisplayButton.className="ime-mode-button";this.modeDisplayText=document.createElement("span");this.modeDisplayText.className="ime-mode-text";this.modeDisplayText.textContent=this.getModeDisplayName(this.currentMode);this.allModeDisplayTexts.push(this.modeDisplayText);this.modeDisplayButton.appendChild(this.modeDisplayText);this.modeDisplayButton.addEventListener('click',(e)=>{e.stopPropagation();if(!this.isEnabled)return;const isMenuVisible=modeContainer.classList.toggle('open');if(isMenuVisible){this.allModeMenus.forEach(menu=>{if(menu!==this.modeMenu){menu.parentElement.classList.remove('open')}});const rect=this.modeDisplayButton.getBoundingClientRect();this.modeMenu.style.visibility='hidden';const menuWidth=this.modeMenu.offsetWidth;const menuHeight=this.modeMenu.offsetHeight;const viewportWidth=window.innerWidth;const viewportHeight=window.innerHeight;if(rect.left+menuWidth>viewportWidth){this.modeMenu.style.left='auto';this.modeMenu.style.right='0'}else{this.modeMenu.style.left='0';this.modeMenu.style.right='auto'}if(rect.bottom+menuHeight>viewportHeight){this.modeMenu.style.top='auto';this.modeMenu.style.bottom='105%'}else{this.modeMenu.style.top='105%';this.modeMenu.style.bottom='auto'}this.modeMenu.style.visibility='visible'}});modeContainer.appendChild(this.modeDisplayButton);this.modeMenu=document.createElement("ul");this.modeMenu.className="ime-mode-menu";this.allModeMenus.push(this.modeMenu);Object.keys(dictionaries).forEach(mode=>{const item=document.createElement("li");item.dataset.mode=mode;item.textContent=this.getModeDisplayName(mode);if(mode===this.currentMode)item.classList.add('active');item.addEventListener("mousedown",(e)=>{e.preventDefault();this.switchMode(mode)});this.modeMenu.appendChild(item)});this.modeMenu.addEventListener('mousedown',(e)=>e.stopPropagation());this.modeMenu.addEventListener('touchstart',(e)=>e.stopPropagation());modeContainer.appendChild(this.modeMenu);this.topBar.appendChild(modeContainer);document.addEventListener('click',(e)=>{if(!modeContainer.contains(e.target)){modeContainer.classList.remove('open')}});const settingsContainer=document.createElement("div");settingsContainer.className="ime-settings-container";this.toneModeToggleBtn=document.createElement("button");this.toneModeToggleBtn.type="button";this.toneModeToggleBtn.className="ime-settings-button";this.toneModeToggleBtn.title="字母/數字";this.toneModeToggleBtn.addEventListener('click',()=>this.toggleToneMode());this.allToneModeButtons.push(this.toneModeToggleBtn);settingsContainer.appendChild(this.toneModeToggleBtn);this.longPhraseToggleBtn=document.createElement("button");this.longPhraseToggleBtn.type="button";this.longPhraseToggleBtn.className="ime-settings-button";this.longPhraseToggleBtn.innerHTML='<span class="material-icons" style="font-size: 18px;">add_box</span>';this.longPhraseToggleBtn.title="長詞連打/音首縮打";this.longPhraseToggleBtn.addEventListener('click',()=>this.toggleLongPhraseMode());this.allLongPhraseButtons.push(this.longPhraseToggleBtn);if(this.isLongPhraseEnabled){this.longPhraseToggleBtn.classList.add('active')}settingsContainer.appendChild(this.longPhraseToggleBtn);this.punctuationModeToggleBtn=document.createElement("button");this.punctuationModeToggleBtn.type="button";this.punctuationModeToggleBtn.className="ime-settings-button";this.punctuationModeToggleBtn.title="全形/半形標點";this.punctuationModeToggleBtn.addEventListener('click',()=>this.togglePunctuationMode());this.allPunctuationButtons.push(this.punctuationModeToggleBtn);settingsContainer.appendChild(this.punctuationModeToggleBtn);this.outputModeToggleBtn=document.createElement("button");this.outputModeToggleBtn.type="button";this.outputModeToggleBtn.className="ime-settings-button";this.outputModeToggleBtn.innerHTML='<span class="material-icons" style="font-size: 18px;">format_size</span>';this.outputModeToggleBtn.title="切換輸出模式";this.outputModeToggleBtn.addEventListener('click',()=>this.toggleOutputMode());this.allOutputModeButtons.push(this.outputModeToggleBtn);settingsContainer.appendChild(this.outputModeToggleBtn);this.topBar.appendChild(settingsContainer);this.toolbarContainer.appendChild(this.topBar);document.body.appendChild(this.toolbarContainer);this.candidatesContainer=document.createElement("div");this.candidatesContainer.id="web-ime-candidates-container";this.candidatesContainer.className="web-ime-base";this.candidatesContainer.style.display='none';const compositionBar=document.createElement("div");compositionBar.id="web-ime-composition-bar";this.compositionDisplay=document.createElement("div");this.compositionDisplay.id="web-ime-composition";compositionBar.appendChild(this.compositionDisplay);const rightControls=document.createElement("div");rightControls.className="ime-right-controls";this.queryBtn=document.createElement("button");this.queryBtn.type="button";this.queryBtn.className="ime-page-button";this.queryBtn.title="字根反查 (/)";this.queryBtn.innerHTML='<span class="material-icons" style="font-size: 20px;">search</span>';this.queryBtn.addEventListener("click",()=>{if(this.isQueryMode){this.exitQueryMode(false)}else if(this.allCandidates.length>0){this.enterQueryMode()}});rightControls.appendChild(this.queryBtn);const pagination=document.createElement("div");pagination.className="ime-pagination";this.prevPageBtn=document.createElement("button");this.prevPageBtn.className="ime-page-button";this.prevPageBtn.innerHTML='<span class="material-icons">chevron_left</span>';this.prevPageBtn.addEventListener("click",()=>this.changePage(-1));this.nextPageBtn=document.createElement("button");this.nextPageBtn.className="ime-page-button";this.nextPageBtn.innerHTML='<span class="material-icons">chevron_right</span>';this.nextPageBtn.addEventListener("click",()=>this.changePage(1));pagination.appendChild(this.prevPageBtn);pagination.appendChild(this.nextPageBtn);rightControls.appendChild(pagination);compositionBar.appendChild(rightControls);this.candidatesContainer.appendChild(compositionBar);this.candidatesList=document.createElement("ul");this.candidatesList.id="web-ime-candidates";this.candidatesContainer.appendChild(this.candidatesList);const settingsBtn=document.createElement("button");settingsBtn.type="button";settingsBtn.className="ime-settings-button";settingsBtn.title="設定";settingsBtn.innerHTML='<span class="material-icons" style="font-size: 16px;">settings</span>';settingsBtn.addEventListener('click',()=>{if(this.settingsModal)this.settingsModal.style.display='flex'});this.allSettingsButtons.push(settingsBtn);settingsContainer.appendChild(settingsBtn);this.createSettingsModal();document.body.appendChild(this.candidatesContainer);this.updateUIState();this.updateToneModeButtonUI()},createExternalToolbar(){if(!this.externalToolbarContainer)return;this.externalToolbarContainer.innerHTML='';const originalEnableContainer=this.topBar.querySelector('.ime-enable-container');if(originalEnableContainer){const newEnableContainer=originalEnableContainer.cloneNode(true);const newToggle=newEnableContainer.querySelector('.ime-enable-toggle');const newLabel=newEnableContainer.querySelector('.ime-enable-label');const newId='web-ime-enable-toggle-external-'+Date.now();newToggle.id=newId;newLabel.htmlFor=newId;newToggle.addEventListener('change',(e)=>{this.setIsEnabled(e.target.checked);const status=this.isEnabled?"已啟用":"已停用";this.showToast(`輸入法${status}`)});this.allEnableToggles.push(newToggle);this.externalToolbarContainer.appendChild(newEnableContainer)}const originalModeContainer=this.topBar.querySelector('.ime-mode-container');if(originalModeContainer){const newModeContainer=originalModeContainer.cloneNode(true);const newModeDisplayButton=newModeContainer.querySelector('.ime-mode-button');const newModeDisplayText=newModeContainer.querySelector('.ime-mode-text');const newModeMenu=newModeContainer.querySelector('.ime-mode-menu');this.allModeDisplayTexts.push(newModeDisplayText);this.allModeMenus.push(newModeMenu);newModeMenu.querySelectorAll('li').forEach(item=>{const mode=item.dataset.mode;item.addEventListener("mousedown",(e)=>{e.preventDefault();this.switchMode(mode)})});newModeDisplayButton.addEventListener('click',(e)=>{e.stopPropagation();if(!this.isEnabled)return;const isMenuVisible=newModeContainer.classList.toggle('open');if(isMenuVisible){this.allModeMenus.forEach(menu=>{if(menu!==newModeMenu){menu.parentElement.classList.remove('open')}});const rect=newModeDisplayButton.getBoundingClientRect();newModeMenu.style.visibility='hidden';const menuWidth=newModeMenu.offsetWidth;const menuHeight=newModeMenu.offsetHeight;const viewportWidth=window.innerWidth;const viewportHeight=window.innerHeight;if(rect.left+menuWidth>viewportWidth){newModeMenu.style.left='auto';newModeMenu.style.right='0'}else{newModeMenu.style.left='0';newModeMenu.style.right='auto'}if(rect.bottom+menuHeight>viewportHeight){newModeMenu.style.top='auto';newModeMenu.style.bottom='105%'}else{newModeMenu.style.top='105%';newModeMenu.style.bottom='auto'}newModeMenu.style.visibility='visible'}});this.externalToolbarContainer.appendChild(newModeContainer)}const createAndRegister=(originalButton,clickHandler,buttonArray)=>{if(!originalButton)return null;const newButton=originalButton.cloneNode(true);newButton.className="toolbar-btn ime-settings-button";newButton.addEventListener('click',clickHandler);buttonArray.push(newButton);this.externalToolbarContainer.appendChild(newButton);return newButton};createAndRegister(this.toneModeToggleBtn,()=>this.toggleToneMode(),this.allToneModeButtons);createAndRegister(this.longPhraseToggleBtn,()=>this.toggleLongPhraseMode(),this.allLongPhraseButtons);createAndRegister(this.punctuationModeToggleBtn,()=>this.togglePunctuationMode(),this.allPunctuationButtons);createAndRegister(this.outputModeToggleBtn,()=>this.toggleOutputMode(),this.allOutputModeButtons);const originalSettingsBtn=this.allSettingsButtons[0];if(originalSettingsBtn){createAndRegister(originalSettingsBtn,()=>{if(this.settingsModal)this.settingsModal.style.display='flex'},this.allSettingsButtons)}},preventModalOverscroll(element){let startY=0;element.addEventListener('touchstart',(e)=>{startY=e.touches[0].pageY},{passive:true});element.addEventListener('touchmove',(e)=>{const currentY=e.touches[0].pageY;const isScrollingUp=currentY<startY;const isAtTop=element.scrollTop===0;const isAtBottom=Math.ceil(element.scrollTop+element.clientHeight)>=element.scrollHeight-1;if(isScrollingUp&&isAtBottom){e.preventDefault();return}if(!isScrollingUp&&isAtTop){e.preventDefault();return}e.stopPropagation()},{passive:false})},createSettingsModal(){this.settingsModal=document.createElement('div');this.settingsModal.id='web-ime-settings-modal';this.settingsModal.style.display='none';this.settingsModal.addEventListener('click',(e)=>{if(e.target===this.settingsModal){this.settingsModal.style.display='none'}});const modalContent=document.createElement('div');modalContent.className='web-ime-modal-content';const modalHeader=document.createElement('div');modalHeader.className='modal-header';modalHeader.innerHTML=`<h3><span class="material-icons"style="vertical-align: bottom; margin-right: 8px;">${randomIconName}</span>烏衣行輸入法設定</h3>`;const closeBtn=document.createElement('button');closeBtn.className='close-button';closeBtn.innerHTML='&times;';closeBtn.onclick=()=>{this.settingsModal.style.display='none'};modalHeader.appendChild(closeBtn);modalContent.appendChild(modalHeader);const modalBody=document.createElement('div');modalBody.className='modal-body';this.preventModalOverscroll(modalBody);const featureSettingsSection=document.createElement('div');featureSettingsSection.className='settings-section';featureSettingsSection.innerHTML='<h4>功能設定</h4>';const featureContainer=document.createElement('div');featureContainer.className='query-options-container';const predictionLabel=document.createElement('label');const predictionCheckbox=document.createElement('input');predictionCheckbox.type='checkbox';predictionCheckbox.id='toggle-prediction';predictionCheckbox.checked=this.config.enablePrediction;predictionCheckbox.onchange=()=>this.savePredictionSettings();predictionLabel.appendChild(predictionCheckbox);predictionLabel.appendChild(document.createTextNode(' 啟用聯想詞'));featureContainer.appendChild(predictionLabel);featureSettingsSection.appendChild(featureContainer);modalBody.appendChild(featureSettingsSection);const toolbarSettingsSection=document.createElement('div');toolbarSettingsSection.className='settings-section';toolbarSettingsSection.innerHTML='<h4>工具列按鈕顯示</h4>';const buttonsContainer=document.createElement('div');buttonsContainer.className='query-options-container';const buttonOptions={'toneMode':'字母/數字','longPhrase':'連打/音首','punctuation':'全形/半形',};for(const key in buttonOptions){const labelText=buttonOptions[key];const label=document.createElement('label');const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.id=`toggle-btn-${key}`;checkbox.dataset.key=key;checkbox.checked=this.config.toolbarButtons[key];checkbox.onchange=()=>this.saveToolbarSettings();label.appendChild(checkbox);label.appendChild(document.createTextNode(`${labelText}`));buttonsContainer.appendChild(label)}const outputModeLabel=document.createElement('label');outputModeLabel.id='web-ime-output-mode-setting-row';outputModeLabel.className='keymap-setting-row';const mainCheckbox=document.createElement('input');mainCheckbox.type='checkbox';mainCheckbox.id='toggle-btn-outputModeToggle';mainCheckbox.dataset.key='outputModeToggle';mainCheckbox.checked=this.config.toolbarButtons.outputModeToggle;outputModeLabel.appendChild(mainCheckbox);outputModeLabel.appendChild(document.createTextNode(' 輸出字音'));const outputModeSelect=document.createElement('select');outputModeSelect.id='output-mode-select';outputModeSelect.style.marginLeft='10px';outputModeSelect.style.display=mainCheckbox.checked?'inline-block':'none';const options=[{value:'pinyin',text:'拼音'},{value:'word_pinyin',text:'字(音)'},{value:'word_pinyin2',text:'字［音］'}];options.forEach(opt=>{const option=document.createElement('option');option.value=opt.value;option.textContent=opt.text;if(this.config.outputMode===opt.value){option.selected=true}outputModeSelect.appendChild(option)});outputModeSelect.addEventListener('change',()=>this.saveOutputModeSettings());outputModeLabel.appendChild(outputModeSelect);mainCheckbox.addEventListener('change',()=>{this.saveToolbarSettings();outputModeSelect.style.display=mainCheckbox.checked?'inline-block':'none'});buttonsContainer.appendChild(outputModeLabel);toolbarSettingsSection.appendChild(buttonsContainer);modalBody.appendChild(toolbarSettingsSection);const keyMapSettingsSection=document.createElement('div');keyMapSettingsSection.className='settings-section';keyMapSettingsSection.innerHTML='<h4>快速鍵設定</h4>';const keyMapContainer=document.createElement('div');keyMapContainer.className='keymap-settings-container';const configurableKeys={'transformTone':'輸出轉換拼音','clearComposition':'清除輸入編碼','backspaceWithCandidates':'刪除(有編碼時)','reverseLookup':'字根反查'};const finalKeyMap={...defaultKeyMap,...this.config.userKeyMap};for(const action in configurableKeys){const labelText=configurableKeys[action];const settingRow=document.createElement('div');settingRow.className='keymap-setting-row';const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.checked=true;const labelSpan=document.createElement('span');labelSpan.className='keymap-label-text';labelSpan.textContent=`${labelText}：`;const input=document.createElement('input');input.type='text';input.id=`key-${action}`;input.dataset.action=action;const currentKey=finalKeyMap[action]?finalKeyMap[action][0]:'';input.value=this.getKeyDisplayName(currentKey);input.dataset.key=currentKey;input.readOnly=true;settingRow.appendChild(checkbox);settingRow.appendChild(labelSpan);settingRow.appendChild(input);keyMapContainer.appendChild(settingRow)}keyMapSettingsSection.appendChild(keyMapContainer);modalBody.appendChild(keyMapSettingsSection);const querySettingsSection=document.createElement('div');querySettingsSection.className='settings-section';querySettingsSection.innerHTML='<h4>字根反查</h4>';const optionsContainer=document.createElement('div');optionsContainer.className='query-options-container';for(const mode in this.reverseDicts){if(Object.keys(this.reverseDicts[mode]).length>0){const displayName=this.getModeDisplayName(mode);const label=document.createElement('label');const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.id=`query-${mode}`;checkbox.value=mode;checkbox.onchange=()=>this.saveQuerySettings();label.appendChild(checkbox);label.appendChild(document.createTextNode(`${displayName}`));optionsContainer.appendChild(label)}}const unicodeLabel=document.createElement('label');const unicodeCheckbox=document.createElement('input');unicodeCheckbox.type='checkbox';unicodeCheckbox.id='query-unicode';unicodeCheckbox.value='unicode';unicodeCheckbox.onchange=()=>this.saveQuerySettings();unicodeLabel.appendChild(unicodeCheckbox);unicodeLabel.appendChild(document.createTextNode(' Unicode'));optionsContainer.appendChild(unicodeLabel);querySettingsSection.appendChild(optionsContainer);modalBody.appendChild(querySettingsSection);const helpSection=document.createElement('div');helpSection.className='settings-section';helpSection.innerHTML='<h4>使用說明</h4>';const helpContent=document.createElement('div');helpContent.className='settings-help-content';helpContent.innerText=`聲調可用字母zˊvˇsˋxˆf⁺lˈ，也可切換為數字。\n「連」打可以連打拼音。\nx是標點。\n空白鍵選第一個候選字。\n也可用,<.>左右移動加空白鍵。\n也可以用數字或shift+數字來選候選字。\n輸入編碼+w可輸出拼音。\nCtrl+/可快速啟用/停用輸入法。`;helpSection.appendChild(helpContent);modalBody.appendChild(helpSection);const resetSection=document.createElement('div');resetSection.className='settings-section';const shareButton=document.createElement('button');shareButton.id='web-ime-share-button';shareButton.textContent='分享設定';resetSection.appendChild(shareButton);const exitImeStateButton=document.createElement('button');exitImeStateButton.id='web-ime-exit-state-button';exitImeStateButton.textContent='離開指定輸入法語言狀態';const params=new URLSearchParams(window.location.search);if(params.has('ime')){exitImeStateButton.disabled=false;exitImeStateButton.addEventListener('click',()=>{const currentUrl=new URL(window.location.href);currentUrl.searchParams.delete('ime');window.location.href=currentUrl.href})}else{exitImeStateButton.disabled=true;exitImeStateButton.title='目前網址不包含指定語言狀態'}resetSection.appendChild(exitImeStateButton);const resetButton=document.createElement('button');resetButton.id='web-ime-reset-button';resetButton.textContent='重設所有設定';resetSection.appendChild(resetButton);modalBody.appendChild(resetSection);modalContent.appendChild(modalBody);this.settingsModal.appendChild(modalContent);document.body.appendChild(this.settingsModal);const keyMapInputs=this.settingsModal.querySelectorAll('input[id^="key-"]');keyMapInputs.forEach(input=>{input.addEventListener('focus',()=>{input.value='請按一個鍵...'});input.addEventListener('blur',()=>{input.value=this.getKeyDisplayName(input.dataset.key||'')});input.addEventListener('keydown',(e)=>{e.preventDefault();const newKey=e.key;input.dataset.key=newKey;input.value=this.getKeyDisplayName(newKey);this.saveKeyMapSettings();input.blur()})});shareButton.addEventListener('click',()=>{const baseUrl=window.location.origin+window.location.pathname;const enabledState='1';const langCode=this.currentMode;const isOutputEnabled=this.config.toolbarButtons.outputModeToggle;let outputModeCode='0';if(isOutputEnabled){if(this.config.outputMode==='pinyin')outputModeCode='1';else if(this.config.outputMode==='word_pinyin')outputModeCode='2';else if(this.config.outputMode==='word_pinyin2')outputModeCode='3'}const settingsCode=[this.config.enablePrediction?'1':'0',this.getCurrentToneMode()==='alphabetic'?'1':'0',this.isLongPhraseEnabled?'1':'0',this.isFullWidthMode?'1':'0',isOutputEnabled?'1':'0',outputModeCode].join('');const shortCode=`${enabledState}-${langCode}-${settingsCode}`;const shareableUrl=`${baseUrl}?ime=${shortCode}`;navigator.clipboard.writeText(shareableUrl).then(()=>{this.showToast('分享網址已複製到剪貼簿');this.settingsModal.style.display='none'}).catch(err=>{console.error('無法複製網址: ',err);this.showToast('複製失敗，您的瀏覽器可能不支援')})});resetButton.addEventListener('click',()=>{this.settingsModal.style.display='none';this.showCustomConfirm('確定要重設所有設定嗎？<br>此操作將會清除所有自訂選項。',()=>{Object.keys(localStorage).forEach(key=>{if(key.startsWith(this.config.storagePrefix)){localStorage.removeItem(key)}});this.showToast('設定已重設，頁面即將重新載入。',2000);setTimeout(()=>{location.reload()},1500)})})},saveQuerySettings(){const enabled={};const checkboxes=this.settingsModal.querySelectorAll('.query-options-container input[type="checkbox"]');checkboxes.forEach(cb=>{if(cb.id.startsWith('query-')){enabled[cb.value]=cb.checked}});this.config.querySettings=enabled;localStorage.setItem(this.config.storagePrefix+'querySettings',JSON.stringify(enabled));this.updateUIState()},loadQuerySettings(){let settings;try{settings=JSON.parse(localStorage.getItem(this.config.storagePrefix+'querySettings'))}catch(e){settings=null}if(!settings){settings={}}this.config.querySettings=settings;if(this.settingsModal){for(const lang in dictionaries){const checkbox=this.settingsModal.querySelector(`#query-${lang}`);if(checkbox){checkbox.checked=!!settings[lang]}}const unicodeCheckbox=this.settingsModal.querySelector('#query-unicode');if(unicodeCheckbox){unicodeCheckbox.checked=!!settings['unicode']}}},saveToolbarSettings(){const checkboxes=this.settingsModal.querySelectorAll('input[id^="toggle-btn-"]');checkboxes.forEach(cb=>{const key=cb.dataset.key;if(key){this.config.toolbarButtons[key]=cb.checked;if(key==='outputModeToggle'&&!cb.checked){this.config.outputModeActive=false;localStorage.setItem(this.config.storagePrefix+'outputModeActive','false');this.updateOutputModeButtonUI()}}});localStorage.setItem(this.config.storagePrefix+'toolbarSettings',JSON.stringify(this.config.toolbarButtons));this.updateToolbarButtonsVisibility()},loadOutputModeSettings(){const saved=localStorage.getItem(this.config.storagePrefix+'outputMode');this.config.outputMode=['pinyin','word_pinyin','word_pinyin2'].includes(saved)?saved:'pinyin';if(this.settingsModal){const selectElement=this.settingsModal.querySelector('#output-mode-select');if(selectElement){selectElement.value=this.config.outputMode}}},saveOutputModeSettings(){const selectElement=this.settingsModal.querySelector('#output-mode-select');if(selectElement){this.config.outputMode=selectElement.value;localStorage.setItem(this.config.storagePrefix+'outputMode',this.config.outputMode)}},loadToolbarSettings(){let settings;try{settings=JSON.parse(localStorage.getItem(this.config.storagePrefix+'toolbarSettings'))}catch(e){settings=null}const defaults={toneMode:true,longPhrase:false,punctuation:false,position:false,outputModeToggle:false,};this.config.toolbarButtons={...defaults,...settings}},loadKeyMapSettings(){let settings;try{settings=JSON.parse(localStorage.getItem(this.config.storagePrefix+'userKeyMap'))}catch(e){settings=null}this.config.userKeyMap=settings||{}},saveKeyMapSettings(){const keyMapInputs=this.settingsModal.querySelectorAll('input[id^="key-"]');const newKeyMap={};keyMapInputs.forEach(input=>{const action=input.dataset.action;const key=input.dataset.key;if(action&&key){newKeyMap[action]=[key]}});this.config.userKeyMap=newKeyMap;localStorage.setItem(this.config.storagePrefix+'userKeyMap',JSON.stringify(newKeyMap))},getKeyDisplayName(key){if(key===' '){return'Space'}return key},updateToolbarButtonsVisibility(){if(!this.toolbarContainer)return;const langProps=imeLanguageProperties[this.currentMode]||{};const nonPinyinModes=['cangjie','xiami','hanglie'];const isLongPhraseSupported=langProps.allowLongPhraseToggle!==false;const isPinyinOutputAvailable=!nonPinyinModes.includes(this.currentMode);const buttonConfig={'toneMode':{elements:this.allToneModeButtons,isSupported:(langProps.toneModes&&langProps.toneModes.length>1)},'longPhrase':{elements:this.allLongPhraseButtons,isSupported:isLongPhraseSupported},'punctuation':{elements:this.allPunctuationButtons,isSupported:true},'outputModeToggle':{elements:this.allOutputModeButtons,isSupported:isPinyinOutputAvailable}};for(const key in buttonConfig){const config=buttonConfig[key];const isEnabledByUser=this.config.toolbarButtons[key];config.elements.forEach(element=>{if(element){if(config.isSupported&&isEnabledByUser){element.style.display=''}else{element.style.display='none'}}})}},attachEventListeners(){const onImeInteractionStart=()=>{this.isClickingInside=true};this.toolbarContainer.addEventListener('mousedown',onImeInteractionStart);this.toolbarContainer.addEventListener('touchstart',onImeInteractionStart,{passive:true});this.candidatesContainer.addEventListener('mousedown',onImeInteractionStart);this.candidatesContainer.addEventListener('touchstart',onImeInteractionStart,{passive:true});this.handleFocusIn=(e)=>{if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable){this.activate(e.target)}};this.handleFocusOut=(e)=>{if(this.isClickingInside){this.isClickingInside=false;if(this.activeElement&&!this.isMobile){this.activeElement.focus()}return}const nextFocusTarget=e.relatedTarget;if(nextFocusTarget&&(nextFocusTarget.tagName==="INPUT"||nextFocusTarget.tagName==="TEXTAREA"||nextFocusTarget.isContentEditable)){this.deactivate();return}this.deactivate();this.hide()};this.boundFocusInHandler=this.handleFocusIn.bind(this);this.boundFocusOutHandler=this.handleFocusOut.bind(this);document.addEventListener("focusin",this.boundFocusInHandler);document.addEventListener("focusout",this.boundFocusOutHandler);document.addEventListener('click',(e)=>{this.allModeMenus.forEach(menu=>{const container=menu.parentElement;if(container&&!container.contains(e.target)){container.classList.remove('open')}})})},activate(element){if(this.activeElement&&this.activeElement!==element){this.deactivate()}this.activeElement=element;this.lastInputValue=this.activeElement.isContentEditable?this.activeElement.textContent:this.activeElement.value;this.show();setTimeout(()=>this.imeReposition(),0);this.activeElement.removeEventListener('click',this.boundReposition);this.activeElement.removeEventListener('keyup',this.boundReposition);this.activeElement.removeEventListener('mouseup',this.boundReposition);this.activeElement.removeEventListener('keydown',this.boundHandleKeyDown);if(this.isMobile){this.activeElement.removeEventListener('input',this.boundHandleInput)}this.activeElement.addEventListener('click',this.boundReposition);this.activeElement.addEventListener('keyup',this.boundReposition);this.activeElement.addEventListener('mouseup',this.boundReposition);const externalToolbar=document.getElementById('ime-external-toolbar-container');if(this.isEnabled){this.toolbarContainer.classList.remove('disabled');if(externalToolbar){externalToolbar.classList.remove('disabled')}this.activeElement.addEventListener('keydown',this.boundHandleKeyDown);if(this.isMobile){this.activeElement.addEventListener('input',this.boundHandleInput)}}else{this.toolbarContainer.classList.add('disabled');if(externalToolbar){externalToolbar.classList.add('disabled')}}},deactivate(){if(!this.activeElement)return;if(this.compositionBuffer){this.commitText(this.compositionBuffer);this.compositionBuffer='';this.compositionCursorPos=0}this.activeElement.removeEventListener('keydown',this.boundHandleKeyDown);if(this.isMobile){this.activeElement.removeEventListener('input',this.boundHandleInput)}this.activeElement.removeEventListener('click',this.boundReposition);this.activeElement.removeEventListener('keyup',this.boundReposition);this.activeElement.removeEventListener('mouseup',this.boundReposition);this.activeElement=null;this.clearCandidates()},imeHandleInput(e){if(this.isCommittingText){return}if(!this.isMobile){if(this.compositionBuffer){this.compositionBuffer='';this.updateCandidates()}return}const target=e.target;const currentVal=target.isContentEditable?target.textContent:target.value;const selectionStart=target.selectionStart;if(currentVal.length>this.lastInputValue.length){const insertedLength=currentVal.length-this.lastInputValue.length;const insertionStart=selectionStart-insertedLength;let diff=currentVal.substring(insertionStart,selectionStart);if(insertedLength>1||!/^[a-zA-Z0-9 ]$/.test(diff)){this.lastInputValue=currentVal;this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates();return}const restoreVal=this.lastInputValue;const restoreCursorPos=insertionStart;this.isCommittingText=true;if(target.isContentEditable){target.textContent=restoreVal}else{target.value=restoreVal}target.setSelectionRange(restoreCursorPos,restoreCursorPos);this.isCommittingText=false;this.lastInputValue=restoreVal;if(diff===' '){const hasBuffer=this.compositionBuffer.length>0;const hasCandidates=this.allCandidates.length>0;if(hasCandidates){this.selectCandidate(this.highlightedIndex)}else if(hasBuffer){this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates()}else{this.commitText(' ')}return}const hasComposition=this.compositionBuffer&&this.allCandidates.length>0;const currentToneMode=this.getCurrentToneMode();const isNumberSelect=currentToneMode==='alphabetic'&&diff.match(/^[1-9]$/)&&hasComposition;const langProps=imeLanguageProperties[this.currentMode]||{};const isTransformEnabled=langProps.enableToneTransform!==false;const isWTransform=diff.toLowerCase()==='w'&&this.compositionBuffer&&isTransformEnabled;if(isNumberSelect||isWTransform){if(isNumberSelect){const index=parseInt(diff,10)-1;if(index<this.candidatesList.children.length){this.selectCandidate(index)}}else{let transformedText=this.compositionBuffer;if(window.imeToneTransformFunctions&&typeof window.imeToneTransformFunctions[this.currentMode]==='function'){transformedText=window.imeToneTransformFunctions[this.currentMode](transformedText)}else{let rules=(window.imeToneTransformRules||{})[this.currentMode];if(rules&&rules.length>0){for(const rule of rules){const regex=new RegExp(rule[0][0],rule[0][1]);transformedText=transformedText.replace(regex,rule[1])}}}this.commitText(transformedText);this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates()}return}const isNumericToneMode=currentToneMode==='numeric'&&langProps.numericToneMap;if(isNumericToneMode&&diff.match(/^[0-9]$/)){const mappedChar=langProps.numericToneMap[diff];if(mappedChar){diff=mappedChar}}this.compositionBuffer+=diff;this.compositionCursorPos+=diff.length;this.updateCandidates()}else if(currentVal.length<this.lastInputValue.length){if(this.compositionBuffer){this.compositionBuffer=this.compositionBuffer.slice(0,-1);this.compositionCursorPos=this.compositionBuffer.length;this.updateCandidates()}this.lastInputValue=currentVal}else{this.lastInputValue=currentVal}},findPhraseCandidates(buffer){const normalizedBuffer=this.normalizeCompositionBuffer(buffer,this.currentMode);const langProps=imeLanguageProperties[this.currentMode]||{};const toneRegex=imeToneMappings[this.currentMode];let processedBuffer=normalizedBuffer;if(langProps.toneType==='numeric'&&toneRegex){processedBuffer=processedBuffer.replace(new RegExp(toneRegex.source,'g'),'')}if(this.phraseCache[processedBuffer]){return this.phraseCache[processedBuffer]}const dictionary=dictionaries[this.currentMode];const simplifiedDict={};for(const key in dictionary){const simplifiedKey=this.simplifyKey(key,this.currentMode);if(!simplifiedDict[simplifiedKey]){simplifiedDict[simplifiedKey]=dictionary[key].split(' ')[0]}}let remainingBuffer=processedBuffer;const path=[];while(remainingBuffer.length>0){let foundMatch=false;for(let i=remainingBuffer.length;i>0;i--){const prefix=remainingBuffer.substring(0,i);if(simplifiedDict[prefix]){path.push(simplifiedDict[prefix]);remainingBuffer=remainingBuffer.substring(i);foundMatch=true;break}}if(!foundMatch){path.length=0;break}}const finalResults=path.length>0?[path.join('')]:[];this.phraseCache[processedBuffer]=finalResults;return finalResults},imeHandleKeyDown(e){if(this.currentMode!=='hanglie'&&e.key===';'&&(!this.candidatesContainer||this.candidatesContainer.style.display==='none')){if(this.isFullWidthMode){e.preventDefault();this.commitText('；');return}}if(e.isComposing||e.keyCode===229)return;if(e.ctrlKey||e.altKey||e.metaKey)return;if(this.isMobile&&e.key&&e.key.length===1&&/[a-zA-Z0-9\s]/.test(e.key)){return}const hasComposition=this.compositionBuffer.length>0;const hasCandidates=this.allCandidates.length>0;const langProps=imeLanguageProperties[this.currentMode]||{};let keyMap={...defaultKeyMap};if(langProps.keyMap){keyMap={...keyMap,...langProps.keyMap}}if(this.config.userKeyMap){for(const action in this.config.userKeyMap){if(this.config.userKeyMap[action]&&this.config.userKeyMap[action].length>0){keyMap[action]=this.config.userKeyMap[action]}}}const reverseKeyMap={};for(const action in keyMap){keyMap[action].forEach(key=>{reverseKeyMap[key]=action})}const action=reverseKeyMap[e.key];if(action){switch(action){case'selectCandidate':if(hasCandidates){e.preventDefault();this.selectCandidate(this.highlightedIndex)}else if(hasComposition){e.preventDefault();const actionOnNoCandidates=langProps.spaceActionOnNoCandidates||'commit';if(actionOnNoCandidates==='clear'){this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates()}else{this.commitText(this.compositionBuffer);this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates()}}return;case'commitComposition':if(!hasComposition){break}e.preventDefault();this.commitText(this.compositionBuffer);this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates();return;case'clearComposition':if(hasComposition||hasCandidates){e.preventDefault();this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates();return}break;case'backspaceWithCandidates':e.preventDefault();if(hasComposition){if(this.compositionCursorPos>0){const buffer=this.compositionBuffer;const pos=this.compositionCursorPos;this.compositionBuffer=buffer.substring(0,pos-1)+buffer.substring(pos);this.compositionCursorPos--;this.updateCandidates()}}else if(this.isPredictionState){this.isPredictionState=false;this.lastCommittedWord='';this.updateCandidates()}return;case'reverseLookup':if(this.isQueryMode||hasCandidates){e.preventDefault();if(this.isQueryMode){this.exitQueryMode(false)}else if(!['cangjie','xiami'].includes(this.currentMode)){this.enterQueryMode()}return}break;case'nextCandidate':if(hasCandidates){e.preventDefault();this.navigateCandidates(1);return}break;case'prevCandidate':if(hasCandidates){e.preventDefault();this.navigateCandidates(-1);return}break;case'nextPage':if(hasCandidates){e.preventDefault();this.changePage(1);return}break;case'prevPage':if(hasCandidates){e.preventDefault();this.changePage(-1);return}break;case'moveCursorLeft':if(hasComposition){e.preventDefault();if(this.compositionCursorPos>0)this.compositionCursorPos--;this.updateCompositionDisplay();return}break;case'moveCursorRight':if(hasComposition){e.preventDefault();if(this.compositionCursorPos<this.compositionBuffer.length)this.compositionCursorPos++;this.updateCompositionDisplay();return}break;case'toggleLongPhrase':if(hasComposition){e.preventDefault();this.toggleLongPhraseMode();return}break;case'transformTone':if(hasComposition){const isTransformEnabled=langProps.enableToneTransform!==false;if(isTransformEnabled){e.preventDefault();let transformedText=this.compositionBuffer;if(window.imeToneTransformFunctions&&typeof window.imeToneTransformFunctions[this.currentMode]==='function'){transformedText=window.imeToneTransformFunctions[this.currentMode](transformedText)}else{let rules=(window.imeToneTransformRules||{})[this.currentMode];if(rules&&rules.length>0){for(const rule of rules){const regex=new RegExp(rule[0][0],rule[0][1]);transformedText=transformedText.replace(regex,rule[1])}}}this.commitText(transformedText);this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates()}}return}}if(this.isFullWidthMode&&!hasComposition){const fullWidthPunctuation={',':'，','.':'。','?':'？',':':'：',"'":'、','[':'「',']':'」','{':'『','}':'』','!':'！','-':'─','(':'（',')':'）','~':'～','<':'〈','>':'〉','_':'＿','"':'…','\\':'【】','|':'《》','\;':'X'};const fullWidthChar=fullWidthPunctuation[e.key];if(fullWidthChar&&!(this.currentMode==='hanglie'&&[',','.',';','/'].includes(e.key))){e.preventDefault();this.commitText(fullWidthChar);return}}if(hasCandidates){const currentToneMode=this.getCurrentToneMode();if(currentToneMode==='alphabetic'&&e.key>='1'&&e.key<='9'){e.preventDefault();const index=parseInt(e.key,10)-1;if(index<this.candidatesList.children.length){this.selectCandidate(index);return}}if(e.shiftKey&&e.code.startsWith('Digit')){const num=e.code.slice(5);if(num>='1'&&num<='9'){const index=parseInt(num,10)-1;if(index<this.candidatesList.children.length){e.preventDefault();this.selectCandidate(index);return}}}}if(e.key==='Backspace'){if(hasComposition){e.preventDefault();if(this.compositionCursorPos>0){const buffer=this.compositionBuffer;const pos=this.compositionCursorPos;this.compositionBuffer=buffer.substring(0,pos-1)+buffer.substring(pos);this.compositionCursorPos--;this.updateCandidates()}}return}const isNumericKey=/^[0-9]$/.test(e.key);if(isNumericKey&&this.getCurrentToneMode()==='alphabetic'&&!hasComposition){return}if(e.key==='+'||e.key==='='){return}if(!this.isMobile&&e.key.length===1&&!reverseKeyMap[e.key]){e.preventDefault();let character=e.key;const currentToneMode=this.getCurrentToneMode();const isNumericToneMode=currentToneMode==='numeric'&&langProps.numericToneMap;if(isNumericToneMode&&character.match(/^[0-9]$/)){if(character in langProps.numericToneMap){character=langProps.numericToneMap[character]}}if(this.compositionBuffer.length<this.config.maxCompositionLength){const buffer=this.compositionBuffer;const pos=this.compositionCursorPos;this.compositionBuffer=buffer.substring(0,pos)+character+buffer.substring(pos);this.compositionCursorPos++;this.updateCandidates()}}},getCurrentToneMode(){const langProps=imeLanguageProperties[this.currentMode]||{};const defaultToneMode=langProps.toneType||(langProps.toneModes&&langProps.toneModes[0])||'alphabetic';return this.toneModes[this.currentMode]||defaultToneMode},updateToneModeButtonUI(){const langProps=imeLanguageProperties[this.currentMode]||{};const shouldShow=langProps.toneModes&&langProps.toneModes.length>1;this.allToneModeButtons.forEach(btn=>{if(shouldShow){btn.style.display='';const currentSetting=this.getCurrentToneMode();const modeText=currentSetting==='numeric'?'調ˇ':'źv̌s̀';btn.textContent=`${modeText}`}else{btn.style.display='none'}})},toggleOutputMode(){this.config.outputModeActive=!this.config.outputModeActive;localStorage.setItem(this.config.storagePrefix+'outputModeActive',this.config.outputModeActive);this.updateOutputModeButtonUI();const statusText=this.config.outputModeActive?'啟用':'停用';this.showToast(`字音輸出已${statusText}`)},updateOutputModeButtonUI(){this.allOutputModeButtons.forEach(btn=>{if(!btn)return;const isEnabled=this.config.outputModeActive;const icon=isEnabled?'translate':'translate';const title=isEnabled?'字音輸出已啟用':'字音輸出已停用';btn.innerHTML=`<span class="material-icons"style="font-size: 18px;">${icon}</span>`;btn.title=title;btn.classList.toggle('active',isEnabled)})},toggleToneMode(){const langProps=imeLanguageProperties[this.currentMode]||{};const availableModes=langProps.toneModes;if(!availableModes||availableModes.length<=1)return;const currentSetting=this.getCurrentToneMode();const currentIndex=availableModes.indexOf(currentSetting);const nextIndex=(currentIndex+1)%availableModes.length;const newMode=availableModes[nextIndex];this.toneModes[this.currentMode]=newMode;localStorage.setItem(this.config.storagePrefix+'toneModes',JSON.stringify(this.toneModes));this.updateToneModeButtonUI();if(this.activeElement)this.activeElement.focus();const modeText=newMode==='numeric'?'數字模式':'字母模式';this.showToast(modeText)},updateCandidates(){this.isPredictionState=false;this.lastCommittedWord='';const activeBuffer=this.compositionBuffer.substring(0,this.compositionCursorPos).toLowerCase();this.updateUIState();this.updateCompositionDisplay();if(activeBuffer.length===0){this.clearCandidates();return}const dictionary=dictionaries[this.currentMode];let candidates=[];if(this.isLongPhraseEnabled){for(let i=activeBuffer.length;i>0;i--){const prefixToSearch=activeBuffer.substring(0,i);let foundCandidatesForPrefix=[];const exactResult=dictionary[prefixToSearch];if(exactResult){exactResult.split(' ').forEach(word=>{foundCandidatesForPrefix.push({word:word,consumed:prefixToSearch})})}this.findPhraseCandidates(prefixToSearch).forEach(word=>{foundCandidatesForPrefix.push({word:word,consumed:prefixToSearch})});this.findSimplePrefixCandidates(prefixToSearch).forEach(word=>{foundCandidatesForPrefix.push({word:word,consumed:prefixToSearch})});if(foundCandidatesForPrefix.length>0){candidates=foundCandidatesForPrefix;break}}}else{const exactResult=dictionary[activeBuffer];if(exactResult){exactResult.split(' ').forEach(word=>{candidates.push({word:word,consumed:activeBuffer})})}this.findSimplePrefixCandidates(activeBuffer).forEach(word=>{candidates.push({word:word,consumed:activeBuffer})});this.findAbbreviationCandidates(activeBuffer).forEach(word=>{candidates.push({word:word,consumed:activeBuffer})})}const uniqueCandidates=new Map();candidates.forEach(c=>{if(!uniqueCandidates.has(c.word)){uniqueCandidates.set(c.word,c)}});this.allCandidates=Array.from(uniqueCandidates.values());this.currentPage=0;this.highlightedIndex=0;this.renderCandidates();this.imeReposition()},findSimplePrefixCandidates(buffer){if(buffer.length<1){return[]}const normalizedBuffer=this.normalizeCompositionBuffer(buffer,this.currentMode);const firstChar=normalizedBuffer[0].toLowerCase();const relevantEntries=this.preprocessedDicts[this.currentMode][firstChar];if(!relevantEntries){return[]}const candidates=[];for(const entry of relevantEntries){if(entry.originalKey.replace(/[\s-]+/g,'').startsWith(normalizedBuffer)){candidates.push(...entry.values)}else if(entry.simplifiedKey.startsWith(normalizedBuffer)){candidates.push(...entry.values)}}return candidates},findAbbreviationCandidates(buffer){if(buffer.length<2){return[]}const normalizedBuffer=this.normalizeCompositionBuffer(buffer,this.currentMode);const firstChar=normalizedBuffer[0].toLowerCase();const relevantEntries=this.preprocessedDicts[this.currentMode][firstChar];if(!relevantEntries){return[]}const candidates=[];for(const entry of relevantEntries){if(entry.originalKey.includes(' ')||entry.originalKey.includes('-')){const abbreviation=entry.originalKey.split(/[\s-]+/).filter(part=>part).map(part=>this.getInitial(part,this.currentMode)).join('');if(abbreviation.startsWith(normalizedBuffer)){candidates.push(...entry.values)}}}return candidates},renderCandidates(){this.candidatesList.innerHTML='';this.updatePaginationButtons();const startIndex=this.currentPage*this.config.candidatesPerPage;const pageCandidates=this.allCandidates.slice(startIndex,startIndex+this.config.candidatesPerPage);pageCandidates.forEach((candidateObj,index)=>{const li=document.createElement('li');if(index===this.highlightedIndex)li.classList.add('highlighted');const indexSpan=document.createElement('span');indexSpan.className='candidate-index';indexSpan.innerHTML=`<sup>${index+1}</sup>`;const textSpan=document.createElement('span');textSpan.className='candidate-text';textSpan.textContent=candidateObj.word;li.appendChild(indexSpan);li.appendChild(textSpan);li.addEventListener('mousedown',(e)=>{e.preventDefault();this.selectCandidate(index)});this.candidatesList.appendChild(li)})},clearCandidates(){this.allCandidates=[];this.renderCandidates();this.updateUIState()},commitText(text){if(!this.activeElement)return;this.isCommittingText=true;if(this.activeElement.isContentEditable){const sel=window.getSelection();if(sel.rangeCount>0){const range=sel.getRangeAt(0);range.deleteContents();const textNode=document.createTextNode(text);range.insertNode(textNode);range.setStartAfter(textNode);range.setEndAfter(textNode);sel.removeAllRanges();sel.addRange(range)}}else{const start=this.activeElement.selectionStart;const end=this.activeElement.selectionEnd;this.activeElement.value=this.activeElement.value.substring(0,start)+text+this.activeElement.value.substring(end);const newCursorPos=start+text.length;this.activeElement.selectionStart=this.activeElement.selectionEnd=newCursorPos}this.lastInputValue=this.activeElement.isContentEditable?this.activeElement.textContent:this.activeElement.value;this.activeElement.dispatchEvent(new Event('input',{bubbles:true}));setTimeout(()=>{this.isCommittingText=false},0)},selectCandidate(indexOnPage){const wasInQueryMode=this.isQueryMode;const startIndex=this.currentPage*this.config.candidatesPerPage;const selectedCandidate=this.allCandidates[startIndex+indexOnPage];if(!selectedCandidate)return;const selectedWord=selectedCandidate.word;const consumedBuffer=this.isPredictionState?selectedWord:selectedCandidate.consumed;const nonPinyinModes=['cangjie','xiami','hanglie'];const isPinyinOutputAvailable=!nonPinyinModes.includes(this.currentMode);let textToCommit=selectedWord;if(this.config.outputModeActive&&this.config.outputMode!=='word'&&isPinyinOutputAvailable){const possibleCodes=this.reverseDicts[this.currentMode]?.[selectedWord];if(possibleCodes&&possibleCodes.length>0){let bestMatchCode=possibleCodes[0];if(possibleCodes.length>1){const simplifiedUserInput=this.simplifyKey(consumedBuffer,this.currentMode);let foundMatch=possibleCodes.find(code=>this.simplifyKey(code,this.currentMode)===simplifiedUserInput);if(!foundMatch){foundMatch=possibleCodes.find(code=>this.simplifyKey(code,this.currentMode).startsWith(simplifiedUserInput))}if(foundMatch){bestMatchCode=foundMatch}}const transformedPinyin=this.transformQueryCode(bestMatchCode,this.currentMode);if(this.config.outputMode==='pinyin'){textToCommit=transformedPinyin}else if(this.config.outputMode==='word_pinyin'){textToCommit=`${selectedWord}(${transformedPinyin})`}else if(this.config.outputMode==='word_pinyin2'){textToCommit=`${selectedWord}［${transformedPinyin}］`}}}this.commitText(textToCommit);const remainingBuffer=this.compositionBuffer.substring(consumedBuffer.length);this.compositionBuffer=remainingBuffer;this.compositionCursorPos=remainingBuffer.length;if(this.compositionBuffer.length>0){this.isPredictionState=false;this.lastCommittedWord='';this.updateCandidates()}else{if(wasInQueryMode){this.exitQueryMode(false);this.updateCandidates();return}const shouldShowPredictions=this.config.enablePrediction&&!(this.config.toolbarButtons.outputModeToggle&&this.config.outputMode!=='word');if(shouldShowPredictions){const predictions=this.findPredictionCandidates(selectedWord);if(predictions.length>0){this.isPredictionState=true;this.lastCommittedWord=selectedWord;this.allCandidates=predictions.map(p=>({word:p,consumed:p}));this.currentPage=0;this.highlightedIndex=0;this.updateCompositionDisplay();this.renderCandidates();this.updateUIState();this.imeReposition();return}}this.isPredictionState=false;this.lastCommittedWord='';this.updateCandidates()}},updateCompositionDisplay(){if(this.compositionDisplay){this.compositionDisplay.innerHTML='';const preCursorText=this.compositionBuffer.substring(0,this.compositionCursorPos);const textSpan=document.createElement('span');textSpan.textContent=this.compositionBuffer;if(this.compositionBuffer){textSpan.style.cursor='pointer'}const measureSpan=document.createElement('span');measureSpan.style.visibility='hidden';measureSpan.style.position='absolute';measureSpan.style.fontFamily='"Consolas", "Courier New", monospace';measureSpan.style.fontSize='16px';measureSpan.style.letterSpacing='1px';measureSpan.textContent=preCursorText;document.body.appendChild(measureSpan);const textWidth=measureSpan.offsetWidth;document.body.removeChild(measureSpan);this.compositionDisplay.appendChild(textSpan);this.compositionDisplay.style.setProperty('--cursor-offset',`${textWidth}px`)}},updateUIState(){if(this.compositionBuffer||this.allCandidates.length>0){this.candidatesContainer.style.display='flex';if(this.compositionDisplay){this.compositionDisplay.style.display=this.compositionBuffer?'block':'none'}const hasQueryOptionEnabled=Object.values(this.config.querySettings||{}).some(v=>v===true);const showQueryButton=this.allCandidates.length>0&&hasQueryOptionEnabled&&!['cangjie','xiami'].includes(this.currentMode);this.queryBtn.style.display=showQueryButton?'flex':'none'}else{this.candidatesContainer.style.display='none';if(this.compositionDisplay){this.compositionDisplay.style.display='none'}this.queryBtn.style.display='none'}},transformQueryCode(code,lang){if(lang==='cangjie'||lang==='xiami'){return code.toUpperCase()}const parts=code.split(/([\s-]+)/);const transformedParts=parts.map(part=>{if(/^[\s-]*$/.test(part)){return part}let transformedSyllable=part;if(window.imeToneTransformFunctions&&typeof window.imeToneTransformFunctions[lang]==='function'){transformedSyllable=window.imeToneTransformFunctions[lang](part)}else{const rules=(window.imeToneTransformRules||{})[lang];if(rules&&rules.length>0){for(const rule of rules){try{const regex=new RegExp(rule[0][0],rule[0][1]);if(regex.test(transformedSyllable)){transformedSyllable=transformedSyllable.replace(regex,rule[1]);break}}catch(e){console.error(`Error applying regex rule for lang"${lang}"on syllable"${part}":`,rule,e)}}}}return transformedSyllable});return transformedParts.join('')},enterQueryMode(){const candidate=this.allCandidates[this.currentPage*this.config.candidatesPerPage+this.highlightedIndex];if(!candidate)return;const candidateWord=candidate.word;this.isQueryMode=true;this.queriedWord=candidateWord;this.originalState={allCandidates:[...this.allCandidates],currentPage:this.currentPage,highlightedIndex:this.highlightedIndex};const queryResults=[];const chars=[...candidateWord];const enabledLangs=this.config.querySettings||{};chars.forEach(char=>{if(enabledLangs.unicode){const codePoint=char.codePointAt(0).toString(16).toUpperCase();queryResults.push(`[U]${char}${codePoint}`)}for(const lang in enabledLangs){if(enabledLangs[lang]&&this.reverseDicts[lang]){const codes=this.reverseDicts[lang][char]||[''];const transformedCodes=codes.map(code=>this.transformQueryCode(code,lang));const displayName=this.getModeDisplayName(lang).charAt(0);queryResults.push(`[${displayName}]${char}${transformedCodes.join(' / ')}`)}}});if(queryResults.length===0){const hasAnyLangEnabled=Object.values(enabledLangs).some(v=>v===true);if(hasAnyLangEnabled){queryResults.push(`「${this.queriedWord}」查無`)}else{queryResults.push('未設定反查')}}this.allCandidates=queryResults.map(item=>({word:item,consumed:this.queriedWord}));this.currentPage=0;this.highlightedIndex=0;this.renderCandidates()},exitQueryMode(commitText=false){if(!this.isQueryMode)return;if(commitText){this.commitText(this.queriedWord);this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates()}else{this.allCandidates=this.originalState.allCandidates;this.currentPage=this.originalState.currentPage;this.highlightedIndex=this.originalState.highlightedIndex;this.renderCandidates()}this.isQueryMode=false;this.queriedWord='';this.originalState=null},togglePinMode(){this.isPinned=!this.isPinned;localStorage.setItem(this.config.storagePrefix+'isPinned',this.isPinned);this.pinToggleBtn.classList.toggle('active',this.isPinned);if(this.isPinned){const rect=this.toolbarContainer.getBoundingClientRect();this.pinnedTop=`${rect.top}px`;this.pinnedLeft=`${rect.left}px`;this.toolbarContainer.style.top=this.pinnedTop;this.toolbarContainer.style.left=this.pinnedLeft;this.toolbarContainer.style.bottom='auto';this.toolbarContainer.style.right='auto';localStorage.setItem(this.config.storagePrefix+'pinnedTop',this.pinnedTop);localStorage.setItem(this.config.storagePrefix+'pinnedLeft',this.pinnedLeft)}else{this.toolbarContainer.style.top='auto';this.toolbarContainer.style.left='10px';this.toolbarContainer.style.bottom='10px';this.toolbarContainer.style.right='auto';localStorage.removeItem(this.config.storagePrefix+'pinnedTop');localStorage.removeItem(this.config.storagePrefix+'pinnedLeft')}if(this.activeElement){this.activeElement.focus()}},setIsEnabled(enabled){this.isEnabled=enabled;const isDisabled=!this.isEnabled;this.allEnableToggles.forEach(toggle=>{toggle.checked=this.isEnabled});if(this.toolbarContainer){this.toolbarContainer.classList.toggle('disabled',isDisabled)}const externalToolbar=document.getElementById('ime-external-toolbar-container');if(externalToolbar){externalToolbar.classList.toggle('disabled',isDisabled)}if(this.activeElement){this.activeElement.removeEventListener('keydown',this.boundHandleKeyDown);this.activeElement.removeEventListener('input',this.boundHandleInput);if(this.isEnabled){this.activeElement.addEventListener('keydown',this.boundHandleKeyDown);if(this.isMobile){this.activeElement.addEventListener('input',this.boundHandleInput)}}}if(isDisabled){this.compositionBuffer='';this.compositionCursorPos=0;this.clearCandidates();if(this.candidatesContainer){this.candidatesContainer.style.display='none'}}},toggleIsEnabled(){this.setIsEnabled(!this.isEnabled);const status=this.isEnabled?"已啟用":"已停用";this.showToast(`輸入法${status}`)},toggleLongPhraseMode(){this.isLongPhraseEnabled=!this.isLongPhraseEnabled;localStorage.setItem(this.config.storagePrefix+'longPhrase',this.isLongPhraseEnabled);this.allLongPhraseButtons.forEach(btn=>{btn.classList.toggle('active',this.isLongPhraseEnabled)});this.updateCandidates();if(this.activeElement)this.activeElement.focus();const modeText=this.isLongPhraseEnabled?'長詞連打':'首音縮打';this.showToast(modeText)},togglePunctuationMode(){this.isFullWidthMode=!this.isFullWidthMode;localStorage.setItem(this.config.storagePrefix+'fullWidth',this.isFullWidthMode);this.updatePunctuationButtonUI();if(this.activeElement)this.activeElement.focus();const modeText=this.isFullWidthMode?'全形標點':'半形標點';this.showToast(modeText)},updatePunctuationButtonUI(){this.allPunctuationButtons.forEach(btn=>{if(btn){btn.innerHTML=this.isFullWidthMode?'<span class="material-icons" style="font-size: 16px;">radio_button_unchecked</span>':'<span class="material-icons" style="font-size: 16px;">tonality</span>';btn.classList.toggle('active',this.isFullWidthMode)}})},navigateCandidates(direction){const itemsOnPage=this.candidatesList.children.length;let newIndex=this.highlightedIndex+direction;if(newIndex<0){if(this.currentPage>0)this.changePage(-1,true)}else if(newIndex>=itemsOnPage){if((this.currentPage+1)*this.config.candidatesPerPage<this.allCandidates.length)this.changePage(1)}else{this.highlightedIndex=newIndex;this.updateHighlight()}},updateHighlight(){this.candidatesList.querySelectorAll('li').forEach((li,index)=>{li.classList.toggle('highlighted',index===this.highlightedIndex)})},changePage(direction,highlightLast=false){const newPage=this.currentPage+direction;const maxPage=Math.ceil(this.allCandidates.length/this.config.candidatesPerPage)-1;if(newPage>=0&&newPage<=maxPage){this.currentPage=newPage;const itemsOnNewPage=this.allCandidates.slice(newPage*this.config.candidatesPerPage,(newPage+1)*this.config.candidatesPerPage).length;this.highlightedIndex=highlightLast?itemsOnNewPage-1:0;this.renderCandidates()}},updatePaginationButtons(){this.prevPageBtn.disabled=this.currentPage===0;const maxPage=Math.ceil(this.allCandidates.length/this.config.candidatesPerPage)-1;this.nextPageBtn.disabled=this.currentPage>=maxPage||this.allCandidates.length===0},switchMode(mode){this.currentMode=mode;localStorage.setItem(this.config.storagePrefix+'mode',mode);const langProps=imeLanguageProperties[this.currentMode]||{};if(langProps.layoutType==='narrow'){this.candidatesContainer.classList.add('ime-narrow')}else{this.candidatesContainer.classList.remove('ime-narrow')}this.config.maxCompositionLength=langProps.maxLength||this.config.globalMaxCompositionLength;if(langProps.allowLongPhraseToggle===false){this.isLongPhraseEnabled=langProps.longPhraseMode===true}else{const savedLongPhrase=localStorage.getItem(this.config.storagePrefix+'longPhrase');if(savedLongPhrase!==null){this.isLongPhraseEnabled=savedLongPhrase==='true'}else{this.isLongPhraseEnabled=this.config.longPhrase}}this.allLongPhraseButtons.forEach(btn=>{btn.classList.toggle('active',this.isLongPhraseEnabled)});if(this.settingsModal){const isPinyinOutputAvailable=!['cangjie','xiami','hanglie'].includes(this.currentMode);const outputSettingRow=this.settingsModal.querySelector('#web-ime-output-mode-setting-row');if(outputSettingRow){outputSettingRow.style.display=isPinyinOutputAvailable?'':'none'}}this.allModeDisplayTexts.forEach(textEl=>{textEl.textContent=this.getModeDisplayName(mode)});this.allModeMenus.forEach(menuEl=>{menuEl.querySelectorAll('li').forEach(item=>{item.classList.toggle('active',item.dataset.mode===mode)});const container=menuEl.parentElement;if(container){container.classList.remove('open')}});this.compositionBuffer='';this.compositionCursorPos=0;this.updateCandidates();this.updateToolbarButtonsVisibility();this.updateToneModeButtonUI();this.updateOutputModeButtonUI();if(this.activeElement)this.activeElement.focus()},getCaretCoordinates(element,position){const mirrorDivId="web-ime-mirror-div";let mirrorDiv=document.getElementById(mirrorDivId);if(!mirrorDiv){mirrorDiv=document.createElement("div");mirrorDiv.id=mirrorDivId;document.body.appendChild(mirrorDiv)}const style=window.getComputedStyle(element);const properties=['border','boxSizing','fontFamily','fontSize','fontWeight','fontStyle','letterSpacing','lineHeight','padding','textAlign','textTransform','wordSpacing','textIndent','whiteSpace','wordWrap','wordBreak'];properties.forEach(prop=>{mirrorDiv.style[prop]=style[prop]});mirrorDiv.style.width=style.width;mirrorDiv.style.position='absolute';mirrorDiv.style.visibility='hidden';mirrorDiv.textContent=element.value.substring(0,position);const span=document.createElement('span');span.textContent='|';mirrorDiv.appendChild(span);const elementRect=element.getBoundingClientRect();const top=elementRect.top+(span.offsetTop-element.scrollTop)+parseInt(style.borderTopWidth);const left=elementRect.left+(span.offsetLeft-element.scrollLeft)+parseInt(style.borderLeftWidth);return{top,left}},imeReposition(){if(this.candidatesContainer.style.display==='none'||!this.activeElement)return;const candidatesContainer=this.candidatesContainer;const activeElement=this.activeElement;let caretRect;const elementRect=activeElement.getBoundingClientRect();if(activeElement.isContentEditable){const selection=window.getSelection();if(selection&&selection.rangeCount>0){const range=selection.getRangeAt(0);const rects=range.getClientRects();if(rects.length>0){caretRect=rects[rects.length-1]}}if(!caretRect||(caretRect.width===0&&caretRect.height===0)){caretRect=elementRect}}else if(activeElement.tagName==='TEXTAREA'||activeElement.tagName==='INPUT'){const coords=this.getCaretCoordinates(activeElement,activeElement.selectionStart);const computedStyle=window.getComputedStyle(activeElement);const lineHeight=parseInt(computedStyle.lineHeight)||(parseInt(computedStyle.fontSize)*1.4);caretRect={top:coords.top,bottom:coords.top+lineHeight,left:coords.left,right:coords.left,height:lineHeight,width:0}}else{caretRect=elementRect}const imeHeight=candidatesContainer.offsetHeight;const imeWidth=candidatesContainer.offsetWidth;const viewportHeight=window.innerHeight;const viewportWidth=window.innerWidth;const margin=10;let finalTop=caretRect.bottom+window.scrollY+5;if((finalTop-window.scrollY+imeHeight)>viewportHeight){if(caretRect.top-imeHeight-5>0){finalTop=caretRect.top+window.scrollY-imeHeight-5}else{finalTop=window.scrollY+viewportHeight-imeHeight-margin}}if(finalTop<window.scrollY+margin){finalTop=window.scrollY+margin}let finalLeft=caretRect.left+window.scrollX;candidatesContainer.style.maxWidth='90vw';if(finalLeft-window.scrollX+imeWidth>viewportWidth-margin){finalLeft=window.scrollX+viewportWidth-imeWidth-margin}if(finalLeft<window.scrollX+margin){finalLeft=window.scrollX+margin}candidatesContainer.style.top=`${finalTop}px`;candidatesContainer.style.left=`${finalLeft}px`;candidatesContainer.style.position='absolute'},show(){this.toolbarContainer.style.display='block'},hide(){this.toolbarContainer.style.display='none';this.candidatesContainer.style.display='none'},getModeDisplayName(mode){const names={'pinyin':'拼音','kasu':'詔安','sixian':'四縣','hailu':'海陸','dapu':'大埔','raoping':'饒平','sixiannan':'南四','holo':'和樂','matsu':'馬祖','cangjie':'倉頡','xiami':'蝦米','hanglie':'行列'};return names[mode]||mode},togglePosition(){this.isPositionRight=!this.isPositionRight;if(this.isPositionRight){localStorage.setItem(this.config.storagePrefix+'position','right')}else{localStorage.removeItem(this.config.storagePrefix+'position')}this.updateToolbarPosition();if(this.activeElement){this.activeElement.focus()}},updateToolbarPosition(){if(this.isPositionRight){this.toolbarContainer.style.left='auto';this.toolbarContainer.style.right='10px'}else{this.toolbarContainer.style.left='10px';this.toolbarContainer.style.right='auto'}},imeInitDrag(e){if(e.target.closest('button, select')){return}if(e.type==='mousedown'&&e.button!==0)return;this.isDragging=true;const rect=this.toolbarContainer.getBoundingClientRect();this.toolbarContainer.style.top=`${rect.top}px`;this.toolbarContainer.style.left=`${rect.left}px`;this.toolbarContainer.style.right='auto';this.toolbarContainer.style.bottom='auto';const touch=e.touches?e.touches[0]:null;const clientX=touch?touch.clientX:e.clientX;const clientY=touch?touch.clientY:e.clientY;this.offsetX=clientX-rect.left;this.offsetY=clientY-rect.top;window.addEventListener('mousemove',this.boundDragMove);window.addEventListener('touchmove',this.boundDragMove,{passive:false});window.addEventListener('mouseup',this.boundDragEnd);window.addEventListener('touchend',this.boundDragEnd);if(e.cancelable){e.preventDefault()}},imeDragMove(e){if(!this.isDragging)return;if(e.type==='touchmove')e.preventDefault();const touch=e.touches?e.touches[0]:null;const clientX=touch?touch.clientX:e.clientX;const clientY=touch?touch.clientY:e.clientY;let newLeft=clientX-this.offsetX;let newTop=clientY-this.offsetY;const margin=10;const imeWidth=this.toolbarContainer.offsetWidth;const imeHeight=this.toolbarContainer.offsetHeight;const viewportWidth=window.innerWidth;const viewportHeight=window.innerHeight;newLeft=Math.max(margin,newLeft);newLeft=Math.min(newLeft,viewportWidth-imeWidth-margin);newTop=Math.max(margin,newTop);newTop=Math.min(newTop,viewportHeight-imeHeight-margin);this.pinnedTop=`${newTop}px`;this.pinnedLeft=`${newLeft}px`;localStorage.setItem(this.config.storagePrefix+'pinnedTop',this.pinnedTop);localStorage.setItem(this.config.storagePrefix+'pinnedLeft',this.pinnedLeft);this.toolbarContainer.style.left=this.pinnedLeft;this.toolbarContainer.style.top=this.pinnedTop},imeDragEnd(){this.isDragging=false;window.removeEventListener('mousemove',this.boundDragMove);window.removeEventListener('touchmove',this.boundDragMove);window.removeEventListener('mouseup',this.boundDragEnd);window.removeEventListener('touchend',this.boundDragEnd)},ensureInBounds(){if(!this.toolbarContainer)return;const rect=this.toolbarContainer.getBoundingClientRect();const viewportWidth=window.innerWidth;const viewportHeight=window.innerHeight;const margin=10;let newLeft=rect.left;let newTop=rect.top;if(newLeft+rect.width>viewportWidth-margin){newLeft=viewportWidth-rect.width-margin}if(newTop+rect.height>viewportHeight-margin){newTop=viewportHeight-rect.height-margin}if(newLeft<margin){newLeft=margin}if(newTop<margin){newTop=margin}if(newLeft!==rect.left||newTop!==rect.top){const finalLeft=`${newLeft}px`;const finalTop=`${newTop}px`;this.toolbarContainer.style.left=finalLeft;this.toolbarContainer.style.top=finalTop;localStorage.setItem(this.config.storagePrefix+'pinnedLeft',finalLeft);localStorage.setItem(this.config.storagePrefix+'pinnedTop',finalTop)}},showCustomConfirm(message,onConfirm){const existingDialog=document.getElementById('web-ime-custom-confirm');if(existingDialog){existingDialog.remove()}const overlay=document.createElement('div');overlay.id='web-ime-custom-confirm';overlay.style.cssText=`position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:10001;opacity:0;transition:opacity 0.2s ease-in-out;`;const dialog=document.createElement('div');dialog.style.cssText=`background:white;border-radius:8px;padding:24px;box-shadow:0 4px 16px rgba(60,64,67,0.15);max-width:320px;width:90%;text-align:center;transform:scale(0.95);transition:transform 0.2s ease-in-out;`;dialog.innerHTML=`<div style="font-size: 16px; color: #202124; line-height: 1.5; margin-bottom: 20px;">${message}</div><div style="display: flex; gap: 8px; justify-content: flex-end;"><button id="ime-confirm-cancel"style="
                background: transparent; border: 1px solid transparent; border-radius: 4px;
                padding: 8px 12px; cursor: pointer; color: #1a73e8; font-size: 14px; font-weight: 500;
            ">取消</button><button id="ime-confirm-ok"style="
                background: #1a73e8; border: none; border-radius: 4px;
                padding: 8px 12px; cursor: pointer; color: white; font-size: 14px; font-weight: 500;
            ">確定重設</button></div>`;overlay.appendChild(dialog);document.body.appendChild(overlay);setTimeout(()=>{overlay.style.opacity='1';dialog.style.transform='scale(1)'},10);const closeDialog=()=>{overlay.style.opacity='0';dialog.style.transform='scale(0.95)';setTimeout(()=>{if(overlay.parentNode){overlay.remove()}},200)};const cancelBtn=document.getElementById('ime-confirm-cancel');const confirmBtn=document.getElementById('ime-confirm-ok');cancelBtn.onclick=closeDialog;overlay.onclick=(e)=>{if(e.target===overlay){closeDialog()}};confirmBtn.onclick=()=>{onConfirm();closeDialog()}},showToast(message,duration=1200){if(this.toastElement&&this.toastElement.parentNode){this.toastElement.remove()}const toast=document.createElement('div');this.toastElement=toast;toast.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.75);color:white;padding:12px 24px;border-radius:8px;z-index:10001;font-size:16px;pointer-events:none;opacity:1;transition:opacity 0.4s ease;`;toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>{toast.style.opacity='0';setTimeout(()=>{if(toast.parentNode){toast.remove()}if(this.toastElement===toast){this.toastElement=null}},400)},duration)},};window.WebIME=WebIME})();const hakkaToneRules=[[['([aeioumngbd])(z)$','g'],'$1ˊ'],[['([aeioumngbd])(v)$','g'],'$1ˇ'],[['([aeioumngbd])(s)$','g'],'$1ˋ'],[['([aeioumngbd])(x)$','g'],'$1ˆ'],[['([aeioumngbd])(f)$','g'],'$1⁺']];window.imeToneTransformRules={'pinyin':[],'sixian':hakkaToneRules,'hailu':hakkaToneRules,'dapu':hakkaToneRules,'raoping':hakkaToneRules,'matsu':hakkaToneRules,'sixiannan':hakkaToneRules};const imeKasuRovToRhoobb=(function(){return function(t){t=t.replace(/\b(r)([aeiou])/g,'rh$2');t=t.replace(/\b(v)([aeiou])/g,'bb$2');t=t.replace(/\b([bpfdtlgkhzcs]|bb|zh|ch|sh|rh)(o)([zvsx]?)\b/g,'$1oo$3');t=t.replace(/\b(o)([zvsx]?)\b/g,'oo$2');t=t.replace(/([aeioumngbd])(z)$/g,'$1ˊ');t=t.replace(/([aeioumngbd])(v)$/g,'$1ˇ');t=t.replace(/([aeioumngbd])(s)$/g,'$1ˋ');t=t.replace(/([aeioumngbd])(x)$/g,'$1ˆ');return t}})();const imeHoloZvsToTone=(function(){return function(t){t=t.replace(/([MNmn])(n)(g|gh)(zz)\b/g,'$1n̋$3');t=t.replace(/([MNmn])(n)(g|gh)(z)\b/g,'$1ń$3');t=t.replace(/([MNmn])(n)(g|gh)(s)\b/g,'$1ǹ$3');t=t.replace(/([MNmn])(n)(g|gh)(x)\b/g,'$1n̂$3');t=t.replace(/([MNmn])(n)(g|gh)(v)\b/g,'$1ň$3');t=t.replace(/([MNmn])(n)(g|gh)(f)\b/g,'$1n̄$3');t=t.replace(/([MNmn])(n)(g|gh)(l)\b/g,'$1n̍$3');t=t.replace(/(O)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'Ő$2');t=t.replace(/(O)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'Ó$2');t=t.replace(/(O)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'Ò$2');t=t.replace(/(O)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'Ô$2');t=t.replace(/(O)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'Ǒ$2');t=t.replace(/(O)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'Ō$2');t=t.replace(/(O)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'O̍$2');t=t.replace(/(o)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'ő$2');t=t.replace(/(o)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'ó$2');t=t.replace(/(o)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'ò$2');t=t.replace(/(o)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'ô$2');t=t.replace(/(o)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'ǒ$2');t=t.replace(/(o)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'ō$2');t=t.replace(/(o)([eiouy]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'o̍$2');t=t.replace(/(Yu)((?:n|ng)?)(f)\b/g,'Ǖ$2');t=t.replace(/(Yu)((?:n|ng)?)(z)\b/g,'Ǘ$2');t=t.replace(/(Yu)((?:n|ng)?)(v)\b/g,'Ǚ$2');t=t.replace(/(Yu)((?:n|ng)?)(s)\b/g,'Ǜ$2');t=t.replace(/(yu)((?:n|ng)?)(f)\b/g,'ǖ$2');t=t.replace(/(yu)((?:n|ng)?)(z)\b/g,'ǘ$2');t=t.replace(/(yu)((?:n|ng)?)(v)\b/g,'ǚ$2');t=t.replace(/(yu)((?:n|ng)?)(s)\b/g,'ǜ$2');t=t.replace(/(Y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'Ȳ$2');t=t.replace(/(Y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'Y̌$2');t=t.replace(/(Y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'Ý$2');t=t.replace(/(Y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'Ỳ$2');t=t.replace(/(Y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'Ŷ$2');t=t.replace(/(y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'ȳ$2');t=t.replace(/(y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'y̌$2');t=t.replace(/(y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'ý$2');t=t.replace(/(y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'ỳ$2');t=t.replace(/(y)([iu]{0,1}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'ŷ$2');t=t.replace(/(A)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'A̋$2');t=t.replace(/(A)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'Á$2');t=t.replace(/(A)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'À$2');t=t.replace(/(A)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'Â$2');t=t.replace(/(A)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'Ǎ$2');t=t.replace(/(A)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'Ā$2');t=t.replace(/(A)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'A̍$2');t=t.replace(/(a)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'a̋$2');t=t.replace(/(a)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'á$2');t=t.replace(/(a)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'à$2');t=t.replace(/(a)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'â$2');t=t.replace(/(a)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'ǎ$2');t=t.replace(/(a)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'ā$2');t=t.replace(/(a)([eiou]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'a̍$2');t=t.replace(/(E)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'E̋$2');t=t.replace(/(E)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'É$2');t=t.replace(/(E)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'È$2');t=t.replace(/(E)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'Ê$2');t=t.replace(/(E)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'Ě$2');t=t.replace(/(E)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'Ē$2');t=t.replace(/(E)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'E̍$2');t=t.replace(/(e)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'e̋$2');t=t.replace(/(e)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'é$2');t=t.replace(/(e)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'è$2');t=t.replace(/(e)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'ê$2');t=t.replace(/(e)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'ě$2');t=t.replace(/(e)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'ē$2');t=t.replace(/(e)([eiur]{0,2}(?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'e̍$2');t=t.replace(/(U)((?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'Ű$2');t=t.replace(/(U)((?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'Ú$2');t=t.replace(/(U)((?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'Ù$2');t=t.replace(/(U)((?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'Û$2');t=t.replace(/(U)((?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'Ǔ$2');t=t.replace(/(U)((?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'Ū$2');t=t.replace(/(U)((?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'U̍$2');t=t.replace(/(u)((?:[mngbdptkh]|nnh|ng|nn)?)(zz)\b/g,'ű$2');t=t.replace(/(u)((?:[mngbdptkh]|nnh|ng|nn)?)(z)\b/g,'ú$2');t=t.replace(/(u)((?:[mngbdptkh]|nnh|ng|nn)?)(s)\b/g,'ù$2');t=t.replace(/(u)((?:[mngbdptkh]|nnh|ng|nn)?)(x)\b/g,'û$2');t=t.replace(/(u)((?:[mngbdptkh]|nnh|ng|nn)?)(v)\b/g,'ǔ$2');t=t.replace(/(u)((?:[mngbdptkh]|nnh|ng|nn)?)(f)\b/g,'ū$2');t=t.replace(/(u)((?:[mngbdptkh]|nnh|ng|nn)?)(l)\b/g,'u̍$2');t=t.replace(/(I)([i]{0,1}(?:[mngbdptkhrr]|nnh|ng|nn)?)(zz)\b/g,'I̋$2');t=t.replace(/(I)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(z)\b/g,'Í$2');t=t.replace(/(I)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(s)\b/g,'Ì$2');t=t.replace(/(I)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(x)\b/g,'Î$2');t=t.replace(/(I)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(v)\b/g,'Ǐ$2');t=t.replace(/(I)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(f)\b/g,'Ī$2');t=t.replace(/(I)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(l)\b/g,'I̍$2');t=t.replace(/(i)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(zz)\b/g,'i̋$2');t=t.replace(/(i)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(z)\b/g,'í$2');t=t.replace(/(i)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(s)\b/g,'ì$2');t=t.replace(/(i)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(x)\b/g,'î$2');t=t.replace(/(i)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(v)\b/g,'ǐ$2');t=t.replace(/(i)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(f)\b/g,'ī$2');t=t.replace(/(i)([i]{0,1}(?:[mngbdptkhr]|nnh|ng|nn)?)(l)\b/g,'i̍$2');t=t.replace(/(M)((?:h)?)(zz)\b/g,'M̋$2');t=t.replace(/(M)((?:h)?)(z)\b/g,'Ḿ$2');t=t.replace(/(M)((?:h)?)(s)\b/g,'M̀$2');t=t.replace(/(M)((?:h)?)(x)\b/g,'M̂$2');t=t.replace(/(M)((?:h)?)(v)\b/g,'M̌$2');t=t.replace(/(M)((?:h)?)(f)\b/g,'M̄$2');t=t.replace(/(M)((?:h)?)(l)\b/g,'M̍$2');t=t.replace(/(m)((?:h)?)(zz)\b/g,'m̋$2');t=t.replace(/(m)((?:h)?)(z)\b/g,'ḿ$2');t=t.replace(/(m)((?:h)?)(s)\b/g,'m̀$2');t=t.replace(/(m)((?:h)?)(x)\b/g,'m̂$2');t=t.replace(/(m)((?:h)?)(v)\b/g,'m̌$2');t=t.replace(/(m)((?:h)?)(f)\b/g,'m̄$2');t=t.replace(/(m)((?:h)?)(l)\b/g,'m̍$2');t=t.replace(/(N)((g|gh)?)(zz)\b/g,'N̋$2');t=t.replace(/(N)((g|gh)?)(z)\b/g,'Ń$2');t=t.replace(/(N)((g|gh)?)(s)\b/g,'Ǹ$2');t=t.replace(/(N)((g|gh)?)(x)\b/g,'N̂$2');t=t.replace(/(N)((g|gh)?)(v)\b/g,'Ň$2');t=t.replace(/(N)((g|gh)?)(f)\b/g,'N̄$2');t=t.replace(/(N)((g|gh)?)(l)\b/g,'N̍$2');t=t.replace(/(n)((g|gh)?)(zz)\b/g,'n̋$2');t=t.replace(/(n)((g|gh)?)(z)\b/g,'ń$2');t=t.replace(/(n)((g|gh)?)(s)\b/g,'ǹ$2');t=t.replace(/(n)((g|gh)?)(x)\b/g,'n̂$2');t=t.replace(/(n)((g|gh)?)(v)\b/g,'ň$2');t=t.replace(/(n)((g|gh)?)(f)\b/g,'n̄$2');t=t.replace(/(n)((g|gh)?)(l)\b/g,'n̍$2');return t}})();window.imeToneTransformFunctions={'holo':imeHoloZvsToTone,'kasu':imeKasuRovToRhoobb};